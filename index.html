<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeeapcel - Login</title>
  <style>
    body {
      background: #f7faff;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      box-sizing: border-box;
      padding: 0;
      width: 100vw;
      overflow-x: hidden;
    }
    .main-center {
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .login-container {
      background: #eaf2fb;
      padding: 5rem 2rem 4.5rem 2rem;
      border-radius: 22px;
      box-shadow: 0 10px 36px rgba(45,108,223,0.10), 0 1.5px 8px rgba(45,108,223,0.06);
      max-width: 370px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2.5px solid #2d6cdf;
      transition: box-shadow 0.2s, border 0.2s, transform 0.18s;
      position: relative;
      margin-top: -11vh;
      margin-left: auto;
      margin-right: auto;
      background-clip: padding-box;
      box-sizing: border-box;
    }
    .login-container:hover {
      box-shadow: 0 16px 48px rgba(45,108,223,0.18), 0 2px 12px rgba(45,108,223,0.13);
      border-color: #1656b7;
      transform: scale(1.025);
    }
    .login-icon {
      font-size: 3rem;
      color: #2d6cdf;
      margin-bottom: 0.9rem;
      margin-top: -3.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      transition: transform 0.18s;
      position: relative;
    }
    .login-icon-bg {
      background: linear-gradient(120deg, #2d6cdf, #4fa3f7, #1656b7, #2d6cdf 80%);
      background-size: 200% 200%;
      animation: spin-gradient 3.5s linear infinite;
      border-radius: 50%;
      width: 92px;
      height: 92px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 24px #b3c6e033, 0 1.5px 8px #2d6cdf22;
      margin: 0 auto;
    }
    .login-icon-bg::before {
      content: "";
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      bottom: 12px;
      border-radius: 50%;
      z-index: 1;
      background: #fff;
    }
    @keyframes spin-gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .login-icon-silhouette {
      position: relative;
      z-index: 2;
      width: 48px;
      height: 48px;
      display: block;
    }
    .login-icon-silhouette svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .login-icon-silhouette svg * {
      fill: #2d6cdf !important; /* Azul para el icono */
      stroke: none !important;
    }
    .logo {
      font-size: 1.6rem; /* Más grande */
      font-weight: 700;
      color: #2266bb;
      margin-bottom: 2.5rem;
      margin-top: -0.5rem;
      letter-spacing: 1.5px;
      text-align: center;
      width: 100%;
      font-family: 'Poppins', 'Montserrat', 'Segoe UI', Arial, sans-serif;
      text-shadow: 0 2px 8px #b3c6e022, 0 1px 0 #fff;
      background: none;
      -webkit-background-clip: initial;
      -webkit-text-fill-color: initial;
      background-clip: initial;
    }
    .login-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      align-items: center;
      justify-content: center;
    }
    .login-form input,
    .login-btn {
      display: block;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
      position: relative;
      top: 1.1rem; /* Baja solo los inputs y el botón un poco menos */
    }
    .login-form input {
      padding: 0.9rem 1.2rem;
      border: 1.7px solid #b3c6e0;
      border-radius: 10px;
      font-size: 1.08rem;
      background: linear-gradient(90deg, #eaf2fb 0%, #f7faff 100%);
      /* Fondo azulito degradado */
      transition: border 0.2s, box-shadow 0.2s, transform 0.18s, background 0.2s;
      outline: none;
      box-shadow: 0 2px 6px rgba(45,108,223,0.06);
      text-align: center;
      width: 100%;
      min-width: 0;
      margin: 0 auto;
      font-family: inherit;
      max-width: 370px;
      color: #2d6cdf;
    }
    .login-form input:focus {
      border: 2px solid #2d6cdf;
      background: linear-gradient(90deg, #eaf2fb 60%, #d6e7fa 100%);
      box-shadow: 0 0 0 2px #b3d1fa;
      transform: scale(1.04);
      color: #0a2540;
    }
    .login-form input:hover {
      border: 2px solid #1656b7;
      background: linear-gradient(90deg, #eaf2fb 0%, #e0edfa 100%);
      transform: scale(1.03);
    }
    .login-btn {
      margin-top: 0.5rem;
      padding: 0.9rem 0;
      background: linear-gradient(90deg, #1656b7 0%, #2d6cdf 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.15rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.18s;
      box-shadow: 0 2px 8px rgba(45,108,223,0.10);
      width: 100%;
      letter-spacing: 1px;
      max-width: 300px;
    }
    .login-btn:hover {
      background: linear-gradient(90deg, #2d6cdf 0%, #1656b7 100%);
      box-shadow: 0 4px 16px rgba(45,108,223,0.13);
      transform: scale(1.04);
    }
    .forgot-nip {
      margin-top: 0.5rem;
      position: relative;
      top: 3.5rem;
      color: #888 !important;
      font-size: 1rem;
      text-align: center;
      width: 100%;
      letter-spacing: 0.5px;
      max-width: 300px;
    }
    footer {
      margin-top: 2rem;
      text-align: center;
      color: #2d6cdf;
      font-size: 0.95rem;
      width: 100vw;
      position: fixed;
      bottom: 0;
      left: 0;
      padding: 1rem 0;
      background: transparent; /* Fondo transparente */
      z-index: 10;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* Permite interactuar con lo que está debajo */
    }
    footer * {
      pointer-events: auto; /* Permite interacción con los enlaces o texto del footer */
    }
    /* --- ADMIN PANEL STYLES --- */
    #adminPanel {
      display: flex;
      position: fixed;
      top: 0;
      left: -242px; /* Deja 8px visibles */
      height: 100vh;
      width: 250px;
      background: #0b4da2;
      color: #ffffff;
      box-shadow: 8px 0 32px #2d6cdf22; /* Sombra a la derecha */
      z-index: 9999; /* Sidebar SIEMPRE al frente de todo */
      flex-direction: column;
      align-items: center;
      padding: 2.2rem 1.2rem 1.2rem 1.2rem;
      transition: left 0.5s cubic-bezier(.77,0,.18,1), box-shadow 0.2s;
      min-width: 0;
      border-top-right-radius: 12px; /* Menos redondeado */
      border-bottom-right-radius: 12px;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #adminPanel::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 8px;
      height: 100%;
      background: #0b4da2;
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      z-index: 201;
      opacity: 0.95;
      pointer-events: none;
      box-shadow: 2px 0 8px #ff980088;
      transition: opacity 0.2s;
    }
    #adminPanel.active::before {
      opacity: 0;
    }
    #adminPanel.active {
      left: 0;
      box-shadow: 8px 0 32px #2d6cdf44;
    }
    /* Zona invisible para detectar hover en la orilla */
    #sidebar-hover-zone {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 24px;
      height: 100vh;
      z-index: 300;
      background: transparent;
      pointer-events: auto;
    }
    #adminPanel .sidebar-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2.1rem;
    }
    #adminPanel .admin-icon {
      background: linear-gradient(135deg, #fff 60%, #eaf2fb 100%);
      color: #2266bb;
      border-radius: 50%;
      width: 80px;   /* Más grande */
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.7rem;
      box-shadow: 0 4px 18px #2266bb33;
      font-size: 2.8rem; /* Más grande */
      border: 3px solid #2d6cdf22;
    }
    #adminPanel .admin-title {
      font-size: 1.6rem; /* Más grande */
      font-weight: 700;
      margin-bottom: 0.15rem;
      letter-spacing: 1.2px;
      text-align: center;
      text-shadow: 0 2px 8px #2d6cdf22;
    }
    #adminPanel .admin-name {
      font-size: 1.25rem; /* Más grande */
      font-weight: 400;
      opacity: 0.97;
      text-align: center;
      letter-spacing: 0.5px;
    }
    #adminPanel .sidebar-buttons {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      margin-bottom: 1.5rem;
    }
    #adminPanel .sidebar-btn {
      display: flex;
      align-items: center;
      gap: 1.1rem;
      background:transparent;
      color: #f4f4f4;
      border: none;
      border-radius: 10px; /* Menos redondeado */
      font-size: 1.35rem;
      white-space: nowrap; /* Texto en una sola línea */
      font-weight: 600;
      padding: 1.2rem 1rem;
      margin: 0;
      cursor: pointer;
      box-shadow: 0 2px 12px #2d6cdf18;
      transition:
        color 0.18s,
        background 0.18s,
        transform 0.22s cubic-bezier(.77,0,.18,1),
        box-shadow 0.18s;
      outline: none;
      position: relative;
      overflow: hidden;
      border-bottom: none;
    }
    #adminPanel .sidebar-btn .btn-icon svg * {
      stroke: #ffffff !important;
      transition: stroke 0.18s;
    }
    #adminPanel .sidebar-btn:hover,
    #adminPanel .sidebar-btn:focus {
      background: rgba(255,152,0,0.11);
      color: #ff9800;
      transform: scale(1.10); /* Añadido para efecto zoom en escritorio */
      /* Quitar transform en móvil */
      box-shadow: 0 8px 28px #ff980033;
    }
    
    @media (max-width: 700px) {
      #adminPanel .sidebar-btn:hover,
      #adminPanel .sidebar-btn:focus {
        transform: none !important;
        box-shadow: 0 4px 16px #ff980033;
      }
      #adminPanel .sidebar-btn:hover .btn-icon,
      #adminPanel .sidebar-btn:focus .btn-icon {
        transform: none !important;
      }
    }
    #adminPanel .sidebar-logout {
      margin-top: auto; /* Lo manda hasta abajo */
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #adminPanel .logout-btn {
      display: flex;
      align-items: center;
      gap: 1.1rem;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 8px; /* Menos redondeado */
      font-size: 1rem; /* Más pequeño */
      font-weight: 700;
      padding: 0.7rem 0.8rem; /* Un poco más pequeño */
      margin: 0 0 1.2rem 0;
      cursor: pointer;
      box-shadow: 0 2px 12px #d32f2f33;
      transition: transform 0.18s, box-shadow 0.18s, background 0.18s, color 0.18s;
      outline: none;
      width: 85%;
      border-bottom: 2.5px solid #b71c1c;
      letter-spacing: 0.5px;
    }
    #adminPanel .logout-btn .btn-icon svg * {
      stroke: #fff !important;
    }
    #adminPanel .logout-btn:hover {
      background: #b71c1c;
      color: #fff;
      box-shadow: 0 8px 28px #d32f2f55;
      transform: scale(1.09) translateX(10px);
    }
    #adminPanel .logout-btn .btn-icon {
      font-size: 2.2rem; /* Icono logout más grande */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.18s;
    }
    #adminPanel .logout-btn:hover .btn-icon {
      transform: scale(1.18) rotate(-8deg);
    }
    @media (max-width: 700px) {
      #adminPanel {
        left: 0 !important;
        width: 100vw;
        min-width: 0;
        max-width: 100vw;
        border-radius: 0;
        box-shadow: 0 2px 16px #2d6cdf22;
        padding: 1.5rem 0.5rem 1.2rem 0.5rem;
        position: fixed;
        top: 0;
        z-index: 101;
      }
      #adminPanel .admin-icon {
        width: 56px;
        height: 56px;
        font-size: 1.8rem;
      }
      #adminPanel .admin-title {
        font-size: 1.15rem;
      }
      #adminPanel .admin-name {
        font-size: 1rem;
      }
      #adminPanel .sidebar-btn, #adminPanel .logout-btn {
        font-size: 1.18rem;
        padding: 1rem 0.7rem;
      }
      #adminPanel .sidebar-btn .btn-icon, #adminPanel .logout-btn .btn-icon {
        font-size: 2.3rem; /* Iconos más grandes en móvil */
      }
      #adminPanel .sidebar-logout {
        margin-top: 1.1rem;
      }
      /* Ajuste logo y texto Telcel en móvil */
      footer img {
        height: 18px !important;
        margin-bottom: 0.18rem !important;
        /* El margen-bottom se ajustará dinámicamente por JS al iniciar sesión */
      }
      footer {
        font-size: 0.62rem !important;
        padding: 0.25rem 0 !important;
      }
    }
    /* --- HAMBURGER BUTTON --- */
    #hamburger-btn {
      display: none;
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 999;
      width: 48px;
      height: 48px;
      background: linear-gradient(120deg, #2266bb 60%, #2d6cdf 100%);
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 12px #2d6cdf33;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s, transform 0.18s;
      outline: none;
      padding: 0;
    }
    #hamburger-btn:active {
      transform: scale(0.96);
      background: linear-gradient(120deg, #1656b7 60%, #2266bb 100%);
    }
    #hamburger-btn .burger {
      display: block;
      width: 26px;
      height: 22px;
      position: relative;
      margin: 0 auto;
      transition: all 0.3s cubic-bezier(.77,0,.18,1);
    }
    #hamburger-btn .burger span {
      display: block;
      position: absolute;
      height: 4px;
      width: 100%;
      background: #fff;
      border-radius: 3px;
      opacity: 1;
      left: 0;
      transition: all 0.3s cubic-bezier(.77,0,.18,1);
    }
    #hamburger-btn .burger span:nth-child(1) {
      top: 0;
    }
    #hamburger-btn .burger span:nth-child(2) {
      top: 9px;
    }
    #hamburger-btn .burger span:nth-child(3) {
      top: 18px;
    }
    #hamburger-btn.active .burger span:nth-child(1) {
      top: 9px;
      transform: rotate(45deg);
    }
    #hamburger-btn.active .burger span:nth-child(2) {
      opacity: 0;
    }
    #hamburger-btn.active .burger span:nth-child(3) {
      top: 9px;
      transform: rotate(-45deg);
    }
    @media (max-width: 700px) {
      #hamburger-btn {
        display: none; /* Por defecto oculto en móvil también */
      }
      #hamburger-btn.visible {
        display: flex !important;
      }
      #adminPanel {
        left: -100vw !important;
        /* Oculto por defecto en móvil */
      }
      #adminPanel.active {
        left: 0 !important;
      }
      #sidebar-hover-zone {
        display: none !important;
      }
      /* Cuando sidebar abierto, oscurecer fondo */
      body.sidebar-open::before {
        content: "";
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(34,102,187,0.13);
        z-index: 98;
        pointer-events: auto;
        transition: background 0.18s;
      }
    }
    /* --- EMPLEADO PANEL STYLES (clon de admin) --- */
    #empleadoPanel {
      display: flex;
      position: fixed;
      top: 0;
      left: -292px;
      height: 100vh;
      width: 300px;
      background: #0b4da2;
      color: #ffffff;
      box-shadow: 8px 0 32px #2d6cdf22;
      z-index: 9999;
      flex-direction: column;
      align-items: center;
      padding: 2.2rem 1.2rem 1.2rem 1.2rem;
      transition: left 0.5s cubic-bezier(.77,0,.18,1), box-shadow 0.2s;
      min-width: 0;
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #empleadoPanel::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 8px;
      height: 100%;
      background: linear-gradient(180deg, #ff9800 0%, #fffbe6 40%, #2d6cdf 100%);
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      z-index: 201;
      opacity: 0.95;
      pointer-events: none;
      box-shadow: 2px 0 8px #ff980088;
      transition: opacity 0.2s;
    }
    #empleadoPanel.active::before {
      opacity: 0;
    }
    #empleadoPanel.active {
      left: 0;
      box-shadow: 8px 0 32px #2d6cdf44;
    }
    #empleadoPanel .sidebar-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2.1rem;
    }
    #empleadoPanel .admin-icon {
      background: linear-gradient(135deg, #fff 60%, #eaf2fb 100%);
      color: #2d6cdf;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.7rem;
      box-shadow: 0 4px 18px #2d6cdf33;
      font-size: 2.8rem;
      border: 3px solid #2d6cdf22;
    }
    #empleadoPanel .admin-title {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 0.15rem;
      letter-spacing: 1.2px;
      text-align: center;
      text-shadow: 0 2px 8px #2d6cdf22;
    }
    #empleadoPanel .admin-name {
      font-size: 1.25rem; /* Más grande */
      font-weight: 400;
      opacity: 0.97;
      text-align: center;
      letter-spacing: 0.5px;
    }
    #empleadoPanel .checkin-status {
      font-size: 0.95rem; /* Ligeramente más pequeño que el nombre */
      font-weight: 600;
      margin-top: 0.5rem; /* Espacio arriba */
      padding: 0.3rem 0.7rem;
      border-radius: 7px;
      text-align: center;
      letter-spacing: 0.3px;
      width: auto; /* Ajustar al contenido */
      max-width: 90%; /* Evitar que sea demasiado ancho */
      display: inline-block; /* Para que padding y border-radius funcionen bien */
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    #empleadoPanel .checkin-status.realizado {
      background-color: #e8f5e9; /* Verde muy claro */
      color: #2e7d32; /* Verde oscuro */
      border: 1px solid #a5d6a7; /* Borde verde claro */
    }
    #empleadoPanel .checkin-status.no-realizado {
      background-color: #ffebee; /* Rojo muy claro */
      color: #c62828; /* Rojo oscuro */
      border: 1px solid #ef9a9a; /* Borde rojo claro */
    }
    #empleadoPanel .checkin-status.en-comida {
      background-color: #e3f2fd; /* Azul muy claro */
      color: #1565c0; /* Azul oscuro */
      border: 1px solid #90caf9; /* Borde azul claro */
    }
    #empleadoPanel .sidebar-buttons {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      margin-bottom: 1.5rem;
    }
    #empleadoPanel .sidebar-btn {
      display: flex;
      align-items: center;
      gap: 1.1rem;
      background:transparent;
      color: #f4f4f4;
      border: none;
      border-radius: 10px; /* Menos redondeado */
      font-size: 1.35rem;
      white-space: nowrap; /* Texto en una sola línea */
      font-weight: 600;
      padding: 1.2rem 1rem;
      margin: 0;
      cursor: pointer;
      box-shadow: 0 2px 12px #2d6cdf18;
      transition:
        color 0.18s,
        background 0.18s,
        transform 0.22s cubic-bezier(.77,0,.18,1),
        box-shadow 0.18s;
      outline: none;
      position: relative;
      overflow: hidden;
      border-bottom: none;
    }
    #empleadoPanel .sidebar-btn .btn-icon svg * {
      stroke: #ffffff !important;
      transition: stroke 0.18s;
    }
    #empleadoPanel .sidebar-btn:hover,
    #empleadoPanel .sidebar-btn:focus {
      background: rgba(255,152,0,0.11);
      color: #ff0000;
      transform: scale(1.10); /* Añadido para efecto zoom en escritorio */
      /* Quitar transform en móvil */
      box-shadow: 0 8px 28px #ff980033;
    }
    
    @media (max-width: 700px) {
      #empleadoPanel .sidebar-btn:hover,
      #empleadoPanel .sidebar-btn:focus {
        transform: none !important;
        box-shadow: 0 4px 16px #ff980033;
      }
      #empleadoPanel .sidebar-btn:hover .btn-icon,
      #empleadoPanel .sidebar-btn:focus .btn-icon {
        transform: none !important;
      }
    }

    #empleadoPanel .sidebar-logout {
      margin-top: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #empleadoPanel .logout-btn {
      display: flex;
      align-items: center;
      gap: 1.1rem;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      padding: 0.7rem 0.8rem;
      margin: 0 0 1.2rem 0;
      cursor: pointer;
      box-shadow: 0 2px 12px #d32f2f33;
      transition: transform 0.18s, box-shadow 0.18s, background 0.18s, color 0.18s;
      outline: none;
      width: 85%;
      border-bottom: 2.5px solid #b71c1c;
      letter-spacing: 0.5px;
    }
    #empleadoPanel .logout-btn .btn-icon svg * {
      stroke: #fff !important;
    }
    #empleadoPanel .logout-btn:hover {
      background: #b71c1c;
      color: #fff;
      box-shadow: 0 8px 28px #d32f2f55;
      transform: scale(1.09) translateX(10px);
    }
    #empleadoPanel .logout-btn .btn-icon {
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.18s;
    }
    #empleadoPanel .logout-btn:hover .btn-icon {
      transform: scale(1.18) rotate(-8deg);
    }
    @media (max-width: 700px) {
      #empleadoPanel {
        left: 0 !important;
        width: 100vw;
        min-width: 0;
        max-width: 100vw;
        border-radius: 0;
        box-shadow: 0 2px 16px #2d6cdf22;
        padding: 1.5rem 0.5rem 1.2rem 0.5rem;
        position: fixed;
        top: 0;
        z-index: 100;
      }
      #empleadoPanel .admin-icon {
        width: 56px;
        height: 56px;
        font-size: 1.8rem;
      }
      #empleadoPanel .admin-title {
        font-size: 1.15rem;
      }
      #empleadoPanel .admin-name {
        font-size: 1rem;
      }
      #empleadoPanel .logout-btn {
        font-size: 1.18rem;
        padding: 1rem 0.7rem;
      }
      #empleadoPanel .logout-btn .btn-icon {
        font-size: 2.3rem;
      }
      #empleadoPanel .sidebar-logout {
        margin-top: 1.1rem;
      }
    }
    /* --- ESTILOS BOTONES ENTRADA/SALIDA --- */
    #empleadoPanel .entrada-btn,
    #empleadoPanel .salida-btn {
      transition: transform 0.18s, box-shadow 0.18s, background 0.18s, color 0.18s; /* Asegurar transición para transform */
    }

    #empleadoPanel .entrada-btn:hover {
      background: #2e7d32; /* Un verde un poco más oscuro al pasar el cursor */
      box-shadow: 0 4px 16px #388e3c55;
      transform: scale(1.09); /* Efecto zoom */
    }

    #empleadoPanel .salida-btn:hover {
      background: #f57c00; /* Un naranja un poco más oscuro al pasar el cursor */
      box-shadow: 0 4px 16px #ff980055;
      transform: scale(1.09); /* Efecto zoom */
    }
  </style>
</head>
<body>
  <!-- Botón hamburguesa solo móvil -->
  <button id="hamburger-btn" aria-label="Abrir menú" type="button" style="display:none;">
    <span class="burger">
      <span></span>
      <span></span>
      <span></span>
    </span>
  </button>
  <!-- Zona invisible para hover en la orilla -->
  <div id="sidebar-hover-zone"></div>
  <div class="main-center" id="loginPanel">
    <div class="login-container">
      <div class="login-icon">
        <span class="login-icon-bg">
          <span class="login-icon-silhouette">
            <!-- Icono de usuario simple y visible en azul -->
            <svg viewBox="0 0 48 48" fill="none">
              <circle cx="24" cy="18" r="9"/>
              <path d="M24 29c-7 0-12 3.2-12 6.5 0 1.7 0 2.5 12 2.5s12-0.8 12-2.5C36 32.2 31 29 24 29z"/>
            </svg>
          </span>
        </span>
      </div>
      <div class="logo">Acceso al Panel</div>
      <form class="login-form">
        <div>
          <input type="text" id="usuario" name="usuario" autocomplete="username" required placeholder="Usuario">
        </div>
        <div>
          <input type="password" id="password" name="password" autocomplete="current-password" required placeholder="Contraseña">
        </div>
        <button class="login-btn" type="submit">Iniciar sesión</button>
        <div class="forgot-nip">¿Olvidaste tu NIP? Contacta a tu administrador.</div>
      </form>
    </div>
  </div>
  <div id="adminPanel">
    <div class="sidebar-header">
      <span class="admin-icon">
        <!-- Icono admin SVG -->
        <svg width="32" height="32" viewBox="0 0 48 48" fill="none">
          <circle cx="24" cy="24" r="24" fill="#eaf2fb"/>
          <circle cx="24" cy="18" r="9" fill="#2266bb"/>
          <ellipse cx="24" cy="34" rx="14" ry="8" fill="#2266bb" fill-opacity="0.7"/>
        </svg>
      </span>
      <span class="admin-title">Admin</span>
      <span class="admin-name" id="adminName">Nombre</span>
    </div>
    <div class="sidebar-buttons">
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono usuario plus -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="8" r="4" stroke="#2266bb" stroke-width="2"/><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" stroke="#2266bb" stroke-width="2"/><path d="M19 8v6M22 11h-6" stroke="#2266bb" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        Crear usuario
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono ver usuarios -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="8" cy="8" r="4" stroke="#2266bb" stroke-width="2"/><circle cx="16" cy="8" r="4" stroke="#2266bb" stroke-width="2"/><path d="M2 21v-2a4 4 0 0 1 4-4h2a4 4 0 0 1 4 4v2" stroke="#2266bb" stroke-width="2"/><path d="M14 21v-2a4 4 0 0 1 4-4h2a4 4 0 0 1 4 4v2" stroke="#2266bb" stroke-width="2"/></svg>
        </span>
        Ver usuarios
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono checadas -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="4" stroke="#2266bb" stroke-width="2"/><path d="M16 2v4" stroke="#2266bb" stroke-width="2"/><path d="M8 2v4" stroke="#2266bb" stroke-width="2"/><path d="M3 10h18" stroke="#2266bb" stroke-width="2"/><circle cx="12" cy="16" r="3" stroke="#2266bb" stroke-width="2"/></svg>
        </span>
        Checadas
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono aviso -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 9v4" stroke="#2266bb" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="17" r="1" fill="#2266bb"/><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="#2266bb" stroke-width="2"/></svg>
        </span>
        Aviso
      </button>
    </div>
    <div class="sidebar-logout">
      <button class="logout-btn" onclick="location.reload()">
        <span class="btn-icon">
          <!-- Icono logout -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="#d32f2f" stroke-width="2"/><path d="M16 17l5-5-5-5" stroke="#d32f2f" stroke-width="2"/><path d="M21 12H9" stroke="#d32f2f" stroke-width="2"/></svg>
        </span>
        Cerrar sesión
      </button>
    </div>
  </div>
  <!-- Recuadro central para funciones admin -->
  <div id="adminContentBox" style="
    display: none;
    position: fixed;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70vw;
    max-width: 850px;
    min-height: 50vh;
    max-height: calc(100vh - 240px);
    background: linear-gradient(120deg, #fafdff 60%, #e2eaff 100%);
    border-radius: 22px;
    box-shadow: 0 8px 32px #2d6cdf22;
    border: 2.5px solid #b3c6e0;
    z-index: 100;
    padding: 3.5rem 1.2rem 2rem 1.2rem;
    margin: 0 auto;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    overflow-y: auto;
    box-sizing: border-box;
  ">
    <div style="color:#2266bb;font-size:1.5rem;font-weight:600;letter-spacing:1px;margin-bottom:1.5rem;text-align:center;">
      Selecciona una función del panel lateral
    </div>
    <div id="adminContentArea" style="width:100%;"></div>
  </div>
  <style>
    /* Ajusta el iframe de formularios y el contenido para que coincidan con el panel */
    #adminContentArea iframe {
      width: calc(100% - 4px) !important;
      max-width: calc(100% - 4px) !important;
      margin: 0 auto !important;
      display: block;
      border-radius: 12px;
      box-sizing: border-box;
    }
    @media (max-width: 700px) {
      #adminContentBox {
        width: 98vw !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        max-width: 99vw !important;
        min-width: 0 !important;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
      #adminContentArea iframe {
        width: calc(100% - 4px) !important;
        max-width: 100% !important;
      }
    }
  </style>
  <div id="empleadoPanel">
    <div class="sidebar-header">
      <span class="admin-icon">
        <!-- Icono empleado SVG -->
        <svg width="32" height="32" viewBox="0 0 48 48" fill="none">
          <circle cx="24" cy="24" r="24" fill="#eaf2fb"/>
          <circle cx="24" cy="18" r="9" fill="#2d6cdf"/>
          <ellipse cx="24" cy="34" rx="14" ry="8" fill="#2d6cdf" fill-opacity="0.7"/>
        </svg>
      </span>
      <span class="admin-title">Empleado</span>
      <span class="admin-name" id="empleadoName">Nombre</span>
      <span class="checkin-status no-realizado" id="checkin-status">CHECK IN: No realizado</span> <!-- TEXTO Y CLASE MODIFICADOS -->
    </div>
    <div class="sidebar-buttons">
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono Tabulador -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="4" width="18" height="16" rx="3" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M3 9h18" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M9 13h6" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        Tabulador
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono Reportes -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="4" width="16" height="16" rx="2" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M8 8h8M8 12h8M8 16h4" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        Reportes
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono Avisos -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 9v4" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="17" r="1" fill="#2d6cdf"/>
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="#2d6cdf" stroke-width="2"/>
          </svg>
        </span>
        Avisos
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono Amigo Paguitos -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="2" y="7" width="20" height="10" rx="3" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M6 11h.01M10 11h.01M14 11h.01M18 11h.01" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        Amigo paguitos
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono Tarifario -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="4" width="16" height="16" rx="2" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M8 8h8M8 12h8M8 16h8" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        Tarifario
      </button>
      <button class="sidebar-btn">
        <span class="btn-icon">
          <!-- Icono Inventarios -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="7" width="18" height="13" rx="2" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M16 3v4M8 3v4" stroke="#2d6cdf" stroke-width="2"/>
            <path d="M3 11h18" stroke="#2d6cdf" stroke-width="2"/>
          </svg>
        </span>
        Inventarios
      </button>
    </div>
    <div class="sidebar-logout">
            <!-- Botón ENTRADA (verde) -->
      <button class="entrada-btn" style="display:flex;align-items:center;gap:1.1rem;background:#388e3c;color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:700;padding:0.7rem 0.8rem;margin:0 0 0.7rem 0;cursor:pointer;box-shadow:0 2px 12px #388e3c33;transition:transform 0.18s,box-shadow 0.18s,background 0.18s,color 0.18s;outline:none;width:85%;border-bottom:2.5px solid #226622;letter-spacing:0.5px;">
        <span class="btn-icon" style="font-size:2.2rem;display:flex;align-items:center;justify-content:center;transition:transform 0.18s;">
          <!-- Icono entrada (flecha hacia adentro) -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M3 12h13" stroke="#fff" stroke-width="2"/>
            <path d="M12 5l7 7-7 7" stroke="#fff" stroke-width="2"/>
          </svg>
        </span>
        ENTRADA
      </button>
      <!-- Botón SALIDA (naranja) -->
      <button class="salida-btn" style="display:flex;align-items:center;gap:1.1rem;background:#ff9800;color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:700;padding:0.7rem 0.8rem;margin:0 0 0.7rem 0;cursor:pointer;box-shadow:0 2px 12px #ff980033;transition:transform 0.18s,box-shadow 0.18s,background 0.18s,color 0.18s;outline:none;width:85%;border-bottom:2.5px solid #b76c00;letter-spacing:0.5px;">
        <span class="btn-icon" style="font-size:2.2rem;display:flex;align-items:center;justify-content:center;transition:transform 0.18s;">
          <!-- Icono salida (flecha hacia afuera) -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M21 12H8" stroke="#fff" stroke-width="2"/>
            <path d="M12 5l-7 7 7 7" stroke="#fff" stroke-width="2"/>
          </svg>
        </span>
        SALIDA
      </button>
      <button class="logout-btn" onclick="location.reload()">
        <span class="btn-icon">
          <!-- Icono logout -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="#d32f2f" stroke-width="2"/><path d="M16 17l5-5-5-5" stroke="#d32f2f" stroke-width="2"/><path d="M21 12H9" stroke="#d32f2f" stroke-width="2"/>
          </svg>
        </span>
        Cerrar sesión
      </button>
    </div>
  </div>
  <footer>
    <img id="telcel-logo" src="https://upload.wikimedia.org/wikipedia/commons/a/ab/Telcel_logo_2022.svg" alt="Logo Telcel" style="height:32px; margin-bottom:0.5rem;">
    <br>
    <span style="color: #888;">
      © 2025 Jeeapcel S.A. de C.V. Todos los derechos reservados.<br>
      Se prohíbe la reproducción, modificación o distribución no autorizada de cualquier parte de este sitio.<br>
      <span style="color: #1656b7;">Desarrollado por Julio García para Jeeapcel S.A. de C.V.</span>
    </span>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script>
    // Configuración de Supabase
    const SUPABASE_URL = 'https://mubtfuksnxtbjxrrwzqh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11YnRmdWtzbnh0Ymp4cnJ3enFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Njc0OTcsImV4cCI6MjA2NDI0MzQ5N30.B7ZyBG2g4hCfdI2A2aX852icnHb_JPpfc0VyO0Zr4PA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- NUEVO: Funciones Helper para Fechas y Horas ---
    function parseChecadaToDate(fechaStr, horaStr) {
      if (!fechaStr || !horaStr || typeof fechaStr !== 'string' || typeof horaStr !== 'string') {
        console.warn("parseChecadaToDate: entrada inválida", fechaStr, horaStr);
        return null;
      }

      const [year, month, day] = fechaStr.split('-').map(Number);
      if (isNaN(year) || isNaN(month) || isNaN(day) || month < 1 || month > 12 || day < 1 || day > 31) {
        console.warn("parseChecadaToDate: fechaStr inválida", fechaStr);
        return null;
      }

      let hours = 0, minutes = 0, seconds = 0;
      let parsedTimeSuccessfully = false;

      // Priorizar formato HH:MM:SS (nuevo formato estándar)
      const twentyFourHourMatch = horaStr.match(/^(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?$/);
      if (twentyFourHourMatch) {
        hours = parseInt(twentyFourHourMatch[1], 10);
        minutes = parseInt(twentyFourHourMatch[2], 10);
        seconds = twentyFourHourMatch[3] ? parseInt(twentyFourHourMatch[3], 10) : 0;
        if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59 && seconds >= 0 && seconds <= 59) {
          parsedTimeSuccessfully = true;
        }
      }
      
      // Intentar formato AM/PM si el parseo de 24 horas falló
      if (!parsedTimeSuccessfully) {
        const ampmMatch = horaStr.match(/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?\s*(a\.m\.|p\.m\.)/i);
        if (ampmMatch) {
          hours = parseInt(ampmMatch[1], 10);
          minutes = parseInt(ampmMatch[2], 10);
          seconds = ampmMatch[3] ? parseInt(ampmMatch[3], 10) : 0;
          const ampm = ampmMatch[4].toLowerCase();

          if (!isNaN(hours) && !isNaN(minutes) && !isNaN(seconds) &&
              hours >= 1 && hours <= 12 && minutes >= 0 && minutes <= 59 && seconds >= 0 && seconds <= 59) {
            if (ampm === 'p.m.' && hours < 12) hours += 12;
            if (ampm === 'a.m.' && hours === 12) hours = 0; // 12 AM es 00 horas
            parsedTimeSuccessfully = true;
          }
        }
      }

      if (parsedTimeSuccessfully) {
        return new Date(year, month - 1, day, hours, minutes, seconds); // Mes en JS es 0-indexado
      } else {
        console.warn("Formato de hora no reconocido en parseChecadaToDate:", horaStr, "para fecha:", fechaStr);
        return null;
      }
    }

    function formatDateToDisplayHora(dateObj) {
      if (dateObj instanceof Date && !isNaN(dateObj)) {
        return dateObj.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: true });
      }
      return ""; 
    }


    function distanciaMetros(lat1, lng1, lat2, lng2) {
  const R = 6371000; // Radio de la Tierra en metros
  const rad = x => x * Math.PI / 180;
  const dLat = rad(lat2 - lat1);
  const dLng = rad(lng2 - lng1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(rad(lat1)) * Math.cos(rad(lat2)) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}


   const SUCURSALES_UBICACION = {
  "A": { lat: 20.134535, lng: -99.234647 },
  "B": { lat: 20.1322194, lng: -99.2337583 },
  "C": { lat: 20.131277, lng: -99.232502 },
  "D": { lat: 20.2296955, lng: -99.2140172 },
  "E": { lat: 20.1314251, lng: -99.2340733 },
  "F": { lat: 20.192013, lng: -99.272670 }
};

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.querySelector('.login-form');
      const loginPanel = document.getElementById('loginPanel');
      const adminPanel = document.getElementById('adminPanel');
      const empleadoPanel = document.getElementById('empleadoPanel');
      const sidebarHoverZone = document.getElementById('sidebar-hover-zone');
      const hamburgerBtn = document.getElementById('hamburger-btn');
      const telcelLogo = document.getElementById('telcel-logo');
      let sidebarVisible = false;
      let hoverTimeout = null;
      let adminLoggedIn = false; // <-- Nuevo flag
      let empleadoLoggedIn = false; // Nuevo flag para empleado
      let empleadoNombre = ""; // Nuevo: para saber el usuario logueado
      let empleadoSucursal = ""; // Nuevo: para saber la sucursal del empleado
      let empleadoId = null; // Nuevo: para guardar el ID del empleado
      // Ocultar el botón hamburguesa al inicio
      hamburgerBtn.classList.remove('visible');
      hamburgerBtn.style.display = 'none';

      adminPanel.classList.remove('active');
      adminPanel.style.display = 'none';

      empleadoPanel.classList.remove('active');
      empleadoPanel.style.display = 'none';

      // --- SIDEBAR HOVER LOGIC (admin y empleado, idéntico) ---
      sidebarHoverZone.addEventListener('mouseenter', function () {
        if (window.innerWidth > 700) {
          if (adminLoggedIn && adminPanel.style.display === 'flex') {
            clearTimeout(hoverTimeout);
            adminPanel.classList.add('active');
            sidebarVisible = true;
          }
          if (empleadoLoggedIn && empleadoPanel.style.display === 'flex') {
            clearTimeout(hoverTimeout);
            empleadoPanel.classList.add('active');
            sidebarVisible = true;
          }
        }
      });

      adminPanel.addEventListener('mouseleave', function () {
        if (window.innerWidth > 700 && adminLoggedIn) {
          hoverTimeout = setTimeout(() => {
            adminPanel.classList.remove('active');
            sidebarVisible = false;
          }, 120);
        }
      });
      adminPanel.addEventListener('mouseenter', function () {
        clearTimeout(hoverTimeout);
      });

      empleadoPanel.addEventListener('mouseleave', function () {
        if (window.innerWidth > 700 && empleadoLoggedIn) {
          hoverTimeout = setTimeout(() => {
            empleadoPanel.classList.remove('active');
            sidebarVisible = false;
          }, 120);
        }
      });
      empleadoPanel.addEventListener('mouseenter', function () {
        clearTimeout(hoverTimeout);
      });

      sidebarHoverZone.addEventListener('mouseleave', function () {
        if (window.innerWidth > 700 && adminLoggedIn && adminPanel.style.display === 'flex' && !adminPanel.matches(':hover')) {
          hoverTimeout = setTimeout(() => {
            adminPanel.classList.remove('active');
            sidebarVisible = false;
          }, 120);
        }
        if (window.innerWidth > 700 && empleadoLoggedIn && empleadoPanel.style.display === 'flex' && !empleadoPanel.matches(':hover')) {
          hoverTimeout = setTimeout(() => {
            empleadoPanel.classList.remove('active');
            sidebarVisible = false;
          }, 120);
        }
      });

      // --- HAMBURGER LOGIC ---
      function closeSidebarMobile() {
        if (adminLoggedIn) {
          adminPanel.classList.remove('active');
          adminPanel.style.display = 'none';
        }
        if (empleadoLoggedIn) {
          empleadoPanel.classList.remove('active');
          empleadoPanel.style.display = 'none';
        }
        hamburgerBtn.classList.remove('active');
        document.body.classList.remove('sidebar-open');
      }
      function openSidebarMobile() {
        if (adminLoggedIn) {
          adminPanel.style.display = 'flex';
          setTimeout(() => adminPanel.classList.add('active'), 10);
          empleadoPanel.style.display = 'none';
          empleadoPanel.classList.remove('active');
          hamburgerBtn.classList.add('active');
          document.body.classList.add('sidebar-open');
        } else if (empleadoLoggedIn) {
          empleadoPanel.style.display = 'flex';
          setTimeout(() => empleadoPanel.classList.add('active'), 10);
          adminPanel.style.display = 'none';
          adminPanel.classList.remove('active');
          hamburgerBtn.classList.add('active');
          document.body.classList.add('sidebar-open');
        }
      }
      hamburgerBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        if (adminLoggedIn) {
          if (adminPanel.classList.contains('active')) {
            closeSidebarMobile();
          } else {
            openSidebarMobile();
          }
        } else if (empleadoLoggedIn) {
          if (empleadoPanel.classList.contains('active')) {
            closeSidebarMobile();
          } else {
            openSidebarMobile();
          }
        }
      });

      // Cerrar sidebar móvil al hacer clic fuera
      document.addEventListener('click', function (e) {
        if (
          window.innerWidth <= 700 &&
          (
            (adminLoggedIn && adminPanel.classList.contains('active') && !adminPanel.contains(e.target) && !hamburgerBtn.contains(e.target)) ||
            (empleadoLoggedIn && empleadoPanel.classList.contains('active') && !empleadoPanel.contains(e.target) && !hamburgerBtn.contains(e.target))
          )
        ) {
          closeSidebarMobile();
        }
      });

      // Al cambiar tamaño de ventana, ocultar sidebar si pasa a escritorio
      window.addEventListener('resize', function () {
        if (window.innerWidth > 700) {
          adminPanel.style.display = adminLoggedIn ? 'flex' : 'none';
          empleadoPanel.style.display = empleadoLoggedIn ? 'flex' : 'none';
          hamburgerBtn.classList.remove('active');
          document.body.classList.remove('sidebar-open');
        } else {
          if (!adminPanel.classList.contains('active')) adminPanel.style.display = 'none';
          if (!empleadoPanel.classList.contains('active')) empleadoPanel.style.display = 'none';
        }
        // Asegurar que el estado del check-in se muestre correctamente al redimensionar
        if (empleadoLoggedIn) {
            // Aquí podrías llamar a una función que verifique el estado real del check-in
            // Por ahora, solo mantenemos el último estado visual conocido o el por defecto.
            const checkinStatusEl = document.getElementById('checkin-status');
            if (!checkinStatusEl.classList.contains('realizado')) {
                 actualizarEstadoCheckInVisual(false); // Mantiene "No realizado" si no se ha hecho check-in
            }
        }
      });

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const usuario = document.getElementById('usuario').value.trim();
        const password = document.getElementById('password').value.trim();

        const { data, error } = await supabase
          .from('usuarios')
          .select('*')
          .eq('nombre', usuario)
          .eq('nip', password)
          .eq('activo', true)
          .maybeSingle();

        if (error) {
          alert('Error de conexión. Intenta de nuevo.');
          return;
        }

        if (!data) {
          alert('Usuario o NIP incorrecto, o usuario inactivo.');
          return;
        }

        if (data.rol === 'admin') {
          document.getElementById('adminName').textContent = data.nombre;
          loginPanel.style.display = 'none';
          adminPanel.style.display = 'flex';
          document.getElementById('adminContentBox').style.display = 'flex';
          adminLoggedIn = true; // <-- Solo después de login admin
          empleadoLoggedIn = false;
          // Mostrar el botón hamburguesa solo después de login admin
          hamburgerBtn.classList.add('visible');
          hamburgerBtn.style.display = '';
          setTimeout(() => {
            if (window.innerWidth > 700) {
              adminPanel.classList.add('active');
            } else {
              adminPanel.classList.remove('active');
              hamburgerBtn.classList.remove('active');
              document.body.classList.remove('sidebar-open');
            }
          }, 10);
          // Ajustar margen del logo Telcel en móvil al iniciar sesión admin
          if (window.innerWidth <= 700) {
            telcelLogo.style.marginBottom = '2.7rem';
          }
          return;
        }
        // --- EMPLEADO LOGIN ---
        if (data.rol === 'empleado') {
          document.getElementById('empleadoName').textContent = data.nombre;
          empleadoNombre = data.nombre; 
          empleadoSucursal = data.sucursal || ""; 
          empleadoId = data.id; // Guardar ID del empleado

          if (!data.sucursal) {
            let sucursalPrompt = prompt("Selecciona tu sucursal (A, B, C, D, E, F):", "");
            if (!sucursalPrompt) {
              alert("Debes seleccionar una sucursal para continuar.");
              return;
            }
            sucursalPrompt = sucursalPrompt.trim().toUpperCase();
            if (!["A","B","C","D","E","F"].includes(sucursalPrompt)) {
              alert("Sucursal inválida. Debe ser A, B, C, D, E o F.");
              return;
            }
            await supabase.from('usuarios').update({ sucursal: sucursalPrompt }).eq('id', data.id);
            data.sucursal = sucursalPrompt;
            empleadoSucursal = sucursalPrompt;
          }
          
          loginPanel.style.display = 'none';
          empleadoPanel.style.display = 'flex';
          document.getElementById('adminContentBox').style.display = 'flex'; // Ocultar por defecto
          empleadoLoggedIn = true;
            adminLoggedIn = false;

            // --- LÓGICA MEJORADA PARA DETERMINAR ESTADO DE CHECK-IN SEGÚN ÚLTIMO REGISTRO ---
            const hoyFechaStr = getFechaLocal();
            const ayerDate = new Date();
            ayerDate.setDate(ayerDate.getDate() - 1);
            const ayerFechaStr = `${ayerDate.getFullYear()}-${(ayerDate.getMonth() + 1).toString().padStart(2, '0')}-${ayerDate.getDate().toString().padStart(2, '0')}`;

            let relevantChecadas = [];

            // Obtener checadas de hoy (TURNO y COMIDA)
            const { data: checadasHoy, error: errorHoy } = await supabase
              .from('checadas')
              .select('tipo, hora, fecha, t2')
              .eq('usuario_id', empleadoId)
              .eq('fecha', hoyFechaStr);

            if (!errorHoy && checadasHoy) {
              relevantChecadas.push(...checadasHoy.filter(c => c.t2 === 'TURNO' || c.t2 === 'COMIDA'));
            } else if (errorHoy) {
              console.error("Error al obtener checadas de hoy:", errorHoy);
            }

            // Obtener checadas de ayer (TURNO y COMIDA)
            const { data: checadasAyer, error: errorAyer } = await supabase
              .from('checadas')
              .select('tipo, hora, fecha, t2')
              .eq('usuario_id', empleadoId)
              .eq('fecha', ayerFechaStr);

            if (!errorAyer && checadasAyer) {
              relevantChecadas.push(...checadasAyer.filter(c => c.t2 === 'TURNO' || c.t2 === 'COMIDA'));
            } else if (errorAyer) {
              console.error("Error al obtener checadas de ayer:", errorAyer);
            }

            if (relevantChecadas.length > 0) {
              const checadasConDateObj = relevantChecadas.map(checada => ({
              ...checada,
              dateTime: parseChecadaToDate(checada.fecha, checada.hora)
              })).filter(c => c.dateTime !== null);

              if (checadasConDateObj.length > 0) {
              checadasConDateObj.sort((a, b) => a.dateTime - b.dateTime);
              const ultima = checadasConDateObj[checadasConDateObj.length - 1];

              if (ultima.tipo === 'salida' && ultima.t2 === 'TURNO') {
                // Última es salida de TURNO: NO REALIZADO
                actualizarEstadoCheckInVisual(false);
              } else if (ultima.tipo === 'entrada' && ultima.t2 === 'TURNO') {
                // Última es entrada de TURNO: REALIZADO
                actualizarEstadoCheckInVisual(true, ultima.hora, ultima.fecha);
              } else if (ultima.tipo === 'entrada' && ultima.t2 === 'COMIDA') {
                // Última es entrada de COMIDA: EN COMIDA
                const statusEl = document.getElementById('checkin-status');
                let mensaje = 'CHECK IN: En comida';
                if (ultima.hora) {
                const dateObj = parseChecadaToDate(ultima.fecha, ultima.hora);
                if (dateObj) {
                  mensaje += ` ${formatDateToDisplayHora(dateObj)}`;
                } else {
                  mensaje += ` ${ultima.hora}`;
                }
                }
                statusEl.textContent = mensaje;
                statusEl.classList.remove('no-realizado', 'realizado');
                statusEl.classList.add('realizado');
              } else if (ultima.tipo === 'salida' && ultima.t2 === 'COMIDA') {
                // Última es salida de COMIDA: buscar última entrada TURNO
                let ultimaEntradaTurno = null;
                for (let i = checadasConDateObj.length - 1; i >= 0; i--) {
                const c = checadasConDateObj[i];
                if (c.tipo === 'entrada' && c.t2 === 'TURNO') {
                  ultimaEntradaTurno = c;
                  break;
                }
                }
                if (ultimaEntradaTurno) {
                actualizarEstadoCheckInVisual(true, ultimaEntradaTurno.hora, ultimaEntradaTurno.fecha);
                } else {
                actualizarEstadoCheckInVisual(false);
                }
              } else {
                actualizarEstadoCheckInVisual(false);
              }
              } else {
              actualizarEstadoCheckInVisual(false);
              }
            } else {
              actualizarEstadoCheckInVisual(false);
            }

            setTimeout(() => {
              if (window.innerWidth > 700) {
              empleadoPanel.classList.add('active');
              } else {
              empleadoPanel.classList.remove('active');
              document.body.classList.remove('sidebar-open');
              }
            }, 10);

          // Mostrar botón hamburguesa solo para empleado en móvil
          hamburgerBtn.classList.add('visible');
          hamburgerBtn.style.display = '';
          // --- NUEVO: Revisar avisos no leídos al iniciar sesión ---
          mostrarNotificacionAvisos();
          return;
        }

        alert('Bienvenido, ' + data.nombre + ' (rol: ' + data.rol + ')');
        // if (data.rol === 'empleado') window.location.href = '/empleado.html';
        // else if (data.rol === 'supervisor') window.location.href = '/supervisor.html';
      });
      // Si cambia el tamaño de pantalla después del login, reajustar el margen
      window.addEventListener('resize', function () {
        if (adminLoggedIn && window.innerWidth <= 700) {
          telcelLogo.style.marginBottom = '2.7rem';
        } else {
          telcelLogo.style.marginBottom = '';
        }
      });
      // Al seleccionar un botón del sidebar ADMIN en móvil, ocultar el sidebar con animación más suave
      document.querySelectorAll('#adminPanel .sidebar-btn').forEach(function(btn) {
        btn.addEventListener('click', function () {
          if (window.innerWidth <= 700) {
            adminPanel.style.transition = 'left 0.7s cubic-bezier(.77,0,.18,1), box-shadow 0.3s';
            adminPanel.classList.add('closing');
            setTimeout(() => {
              adminPanel.classList.remove('active');
              hamburgerBtn.classList.remove('active');
              document.body.classList.remove('sidebar-open');
              adminPanel.classList.remove('closing');
              adminPanel.style.transition = ''; // Restablece transición
            }, 600); // Más tiempo para suavidad
          } else {
            adminPanel.classList.remove('active');
            sidebarVisible = false;
          }
        });
      });

      // Al seleccionar un botón del sidebar EMPLEADO en móvil, ocultar el sidebar igual que admin
      document.querySelectorAll('#empleadoPanel .sidebar-btn').forEach(function(btn, idx) {
        btn.addEventListener('click', function () {
          // Oculta el mensaje de "Selecciona una función del panel lateral"
          var msg = document.querySelector('#adminContentBox > div');
          if (msg) msg.style.display = 'none';

          // TABULADOR (índice 0)
          if (idx === 0) {
            document.getElementById('adminContentBox').style.display = 'flex';
            document.getElementById('adminContentArea').innerHTML = `
              <form id="tabulador-form" style="max-width:390px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:1.1rem;background:linear-gradient(120deg,#fafdff 70%,#e2eaff 100%);border-radius:18px;box-shadow:0 4px 18px #2d6cdf22;padding:1.5rem 1.2rem 1.1rem 1.2rem;">
                <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%;">
                  <div style="flex:1 1 140px;min-width:140px;max-width:160px;">
                    <label style="font-weight:600;color:#2266bb;display:block;text-align:center;">Fecha<br>
                      <input type="date" id="tab-fecha" required style="width:100%;max-width:140px;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;">
                    </label>
                  </div>
                  <div style="flex:1 1 140px;min-width:140px;max-width:160px;">
                    <label style="font-weight:600;color:#2266bb;display:block;text-align:center;">Sucursal<br>
                      <select id="tab-sucursal" required style="width:100%;max-width:140px;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;">
                        <option value="">Selecciona</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                      </select>
                    </label>
                  </div>
                </div>
                <div style="width:100%;max-width:240px;">
                  <label style="font-weight:600;color:#2266bb;">Responsable<br>
                    <input type="text" id="tab-responsable" required placeholder="Nombre" style="width:100%;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;">
                  </label>
                </div>
                <fieldset style="border:1.5px solid #2d6cdf;border-radius:14px;padding:1.2rem 0.5rem 1rem 0.5rem;background:#f7faff;display:flex;flex-direction:column;align-items:center;width:100%;max-width:260px;">
                  <legend style="color:#2d6cdf;font-weight:700;font-size:1.1rem;padding:0 0.7rem;text-align:center;">Billetes</legend>
                  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.1rem 0.5rem;justify-items:center;">
                    <label style="display:flex;align-items:center;gap:0.4rem;font-size:1.08rem;">
                      <span style="background:#2266bb;color:#fff;padding:0.18rem 0.5rem;border-radius:7px;font-weight:600;">$1000</span>
                      <input type="number" min="0" id="billete-1000" value="0" style="width:38px;padding:0.2rem 0.2rem;border-radius:7px;border:1px solid #b3c6e0;text-align:center;">
                    </label>
                    <label style="display:flex;align-items:center;gap:0.4rem;font-size:1.08rem;">
                      <span style="background:#2266bb;color:#fff;padding:0.18rem 0.5rem;border-radius:7px;font-weight:600;">$500</span>
                      <input type="number" min="0" id="billete-500" value="0" style="width:38px;padding:0.2rem 0.2rem;border-radius:7px;border:1px solid #b3c6e0;text-align:center;">
                    </label>
                    <label style="display:flex;align-items:center;gap:0.4rem;font-size:1.08rem;">
                      <span style="background:#2266bb;color:#fff;padding:0.18rem 0.5rem;border-radius:7px;font-weight:600;">$200</span>
                      <input type="number" min="0" id="billete-200" value="0" style="width:38px;padding:0.2rem 0.2rem;border-radius:7px;border:1px solid #b3c6e0;text-align:center;">
                    </label>
                    <label style="display:flex;align-items:center;gap:0.4rem;font-size:1.08rem;">
                      <span style="background:#2266bb;color:#fff;padding:0.18rem 0.5rem;border-radius:7px;font-weight:600;">$100</span>
                      <input type="number" min="0" id="billete-100" value="0" style="width:38px;padding:0.2rem 0.2rem;border-radius:7px;border:1px solid #b3c6e0;text-align:center;">
                    </label>
                    <label style="display:flex;align-items:center;gap:0.4rem;font-size:1.08rem;">
                      <span style="background:#2266bb;color:#fff;padding:0.18rem 0.5rem;border-radius:7px;font-weight:600;">$50</span>
                      <input type="number" min="0" id="billete-50" value="0" style="width:38px;padding:0.2rem 0.2rem;border-radius:7px;border:1px solid #b3c6e0;text-align:center;">
                    </label>
                    <label style="display:flex;align-items:center;gap:0.4rem;font-size:1.08rem;">
                      <span style="background:#2266bb;color:#fff;padding:0.18rem 0.5rem;border-radius:7px;font-weight:600;">$20</span>
                      <input type="number" min="0" id="billete-20" value="0" style="width:38px;padding:0.2rem 0.2rem;border-radius:7px;border:1px solid #b3c6e0;text-align:center;">
                    </label>
                  </div>
                </fieldset>
                <div style="width:100%;max-width:140px;text-align:center;">
                  <label style="font-weight:600;color:#2266bb;display:block;text-align:center;">Monedas<br>
                    <input type="number" min="0" step="1" id="monedas" value="0" style="width:70px;padding:0.5rem 0.3rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;">
                  </label>
                </div>
                <button type="button" id="calcular-tabulador" style="padding:0.9rem 0;background:linear-gradient(90deg,#1656b7 0%,#2d6cdf 100%);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:1.15rem;cursor:pointer;box-shadow:0 2px 8px #2d6cdf22;transition:background 0.2s;width:100%;max-width:220px;margin-top:0.5rem;">Calcular total</button>
                <button type="button" id="generar-etiqueta" style="padding:0.7rem 0;background:#ff9800;color:#fff;border:none;border-radius:10px;font-weight:700;font-size:1.08rem;cursor:pointer;box-shadow:0 2px 8px #ff980033;transition:background 0.2s;width:100%;max-width:220px;margin-top:0.2rem;">Generar etiqueta</button>
                <div id="tabulador-total" style="margin-top:1.3rem;font-size:1.25rem;color:#1656b7;font-weight:800;text-align:center;letter-spacing:1px;width:100%;"></div>
              </form>
              <div id="etiqueta-modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
                <div id="etiqueta-modal" style="background:#fff;border-radius:14px;box-shadow:0 4px 32px #2d6cdf33;padding:1.2rem 0.7rem;min-width:0;max-width:95vw;display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;top:30px;left:250px;">
                  <div id="etiqueta-content" style="width:62mm;max-width:95vw;background:#fff;border-radius:10px;padding:0.7rem 0.5rem;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto;"></div>
                  <div style="display:flex;gap:0.7rem;margin-top:1.1rem;">
                    <button id="imprimir-etiqueta" style="padding:0.5rem 1.2rem;border-radius:8px;border:none;background:#1656b7;color:#fff;font-weight:700;font-size:1rem;cursor:pointer;">Imprimir</button>
                    <button id="descargar-etiqueta" style="padding:0.5rem 1.2rem;border-radius:8px;border:none;background:#4fa3f7;color:#fff;font-weight:700;font-size:1rem;cursor:pointer;">Descargar</button>
                    <button id="cerrar-etiqueta" style="padding:0.5rem 1.2rem;border-radius:8px;border:none;background:#d32f2f;color:#fff;font-weight:700;font-size:1rem;cursor:pointer;">Cerrar</button>
                  </div>
                </div>
              </div>
            `;
            // Lógica de cálculo
            setTimeout(function() {
              document.getElementById('calcular-tabulador').onclick = function() {
                const billetes = [1000,500,200,100,50,20];
                let total = 0;
                billetes.forEach(denom => {
                  const cant = parseInt(document.getElementById('billete-'+denom).value) || 0;
                  total += cant * denom;
                });
                const monedas = parseFloat(document.getElementById('monedas').value) || 0;
                total += monedas;
                document.getElementById('tabulador-total').textContent = 'Total: $' + total.toLocaleString('es-MX', {minimumFractionDigits:2});
              };

              // Generar etiqueta
              document.getElementById('generar-etiqueta').onclick = function() {
                const sucursal = document.getElementById('tab-sucursal').value || '';
                const responsable = document.getElementById('tab-responsable').value || '';
                const fecha = document.getElementById('tab-fecha').value || '';
                const billetes = [1000,500,200,100,50,20];
                let total = 0;
                const billQuantities = {}; // Objeto para almacenar las cantidades

                billetes.forEach(denom => {
                  const cant = parseInt(document.getElementById('billete-'+denom).value) || 0;
                  billQuantities[denom] = cant; // Almacenar cantidad
                  total += cant * denom;
                });
                const monedas = parseInt(document.getElementById('monedas').value) || 0;
                total += monedas;

                // Texto para QR
                const qrData = 
                  'Sucursal: ' + sucursal + '\\n' +
                  'Responsable: ' + responsable + '\\n' +
                  'Fecha: ' + fecha + '\\n' +
                  '$1000: ' + billQuantities[1000] + '\\n' +
                  '$500: ' + billQuantities[500] + '\\n' +
                  '$200: ' + billQuantities[200] + '\\n' +
                  '$100: ' + billQuantities[100] + '\\n' +
                  '$50: ' + billQuantities[50] + '\\n' +
                  '$20: ' + billQuantities[20] + '\\n' +
                  'Monedas: ' + monedas + '\\n' +
                  'Total: $' + total.toLocaleString('es-MX', {minimumFractionDigits:2});

                // Generar QR con API externa (quickchart.io)
                const qrUrl = 'https://quickchart.io/qr?text=' + encodeURIComponent(qrData) + '&size=180';

                // Etiqueta HTML
                document.getElementById('etiqueta-content').innerHTML = `
                  <div style="width:100%;text-align:left;">
                    <div style="font-weight:800;font-size:1.1rem;margin-bottom:0.3rem;">Sucursal: <span style="font-weight:700;">${sucursal}</span></div>
                    <div style="font-weight:700;font-size:1rem;margin-bottom:0.2rem;">Responsable: <span style="font-weight:500;">${responsable}</span></div>
                    <div style="font-weight:700;font-size:1rem;margin-bottom:0.5rem;">Fecha: <span style="font-weight:500;">${fecha}</span></div>
                    <div style="font-size:1rem;margin-bottom:0.2rem;">$1000: <b>${billQuantities[1000]}</b></div>
                    <div style="font-size:1rem;margin-bottom:0.2rem;">$500: <b>${billQuantities[500]}</b></div>
                    <div style="font-size:1rem;margin-bottom:0.2rem;">$200: <b>${billQuantities[200]}</b></div>
                    <div style="font-size:1rem;margin-bottom:0.2rem;">$100: <b>${billQuantities[100]}</b></div>
                    <div style="font-size:1rem;margin-bottom:0.2rem;">$50: <b>${billQuantities[50]}</b></div>
                    <div style="font-size:1rem;margin-bottom:0.2rem;">$20: <b>${billQuantities[20]}</b></div>
                    <div style="font-size:1rem;margin-bottom:0.5rem;">Monedas: <b>${monedas}</b></div>
                  </div>
                  <div style="width:100%;display:flex;justify-content:center;margin:0.7rem 0;">
                    <img id="qr-img-etiqueta" src="${qrUrl}" alt="QR etiqueta" style="width:120px;height:120px;">
                  </div>
                  <div style="width:100%;text-align:center;font-weight:800;font-size:1.15rem;margin-top:0.3rem;">Total: $${total.toLocaleString('es-MX', {minimumFractionDigits:2})}</div>
                `;
                document.getElementById('etiqueta-modal-bg').style.display = 'flex';

                // Esperar a que el QR cargue antes de permitir descargar
                const descargarBtn = document.getElementById('descargar-etiqueta');
                descargarBtn.disabled = true;
                const qrImg = document.getElementById('qr-img-etiqueta');
                qrImg.onload = function() {
                  descargarBtn.disabled = false;
                };

                // Botón imprimir
                document.getElementById('imprimir-etiqueta').onclick = function() {
                  const etiqueta = document.getElementById('etiqueta-content').innerHTML;
                  const printWindow = window.open('', '', 'width=300,height=600');
                  printWindow.document.write(`
                    <html>
                    <head>
                      <title>Imprimir Etiqueta</title>
                      <style>
                        @media print {
                          body { margin:0; }
                          #etiqueta-print { width:62mm !important; max-width:62mm !important; }
                        }
                        #etiqueta-print {
                          width:62mm; max-width:62mm; background:#fff; border-radius:10px; padding:0.7rem 0.5rem; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:center; margin:0 auto;
                        }
                      </style>
                    </head>
                    <body>
                      <div id="etiqueta-print">${etiqueta}</div>
                      <script>
                        window.onload = function() { window.print(); setTimeout(()=>window.close(), 500); }
                      <\/script>
                    </body>
                    </html>
                  `);
                  printWindow.document.close();
                };

                // Botón descargar (como imagen, incluye QR)
                document.getElementById('descargar-etiqueta').onclick = function() {
                  const etiquetaDiv = document.getElementById('etiqueta-content');
                  // Esperar a que el QR esté cargado
                  html2canvas(etiquetaDiv, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: "#fff"
                  }).then(function(canvas) {
                    const link = document.createElement('a');
                    link.download = 'etiqueta-tabulador.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                  });
                };

                // Botón cerrar (arreglado)
                document.getElementById('cerrar-etiqueta').onclick = function() {
                  document.getElementById('etiqueta-modal-bg').style.display = 'none';
                };
              };
            }, 50);
          }
          // Si es el botón de Reportes (índice 1)
          if (idx === 1) {
            window.open('https://forms.gle/KAYTAxrf6kakFNVP8', '_blank');
            return;
          }
          // Si es el botón de Amigo paguitos (índice 3)
          if (idx === 3) {
            document.getElementById('adminContentBox').style.display = 'flex';
            var altura = Math.max(window.innerHeight * 0.85, 600); // mínimo 600px
            document.getElementById('adminContentArea').innerHTML = `
              <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSc_rGTuBDJ3IcqjMFk0xnkte_foRZaQWJ6k2tbDQ6h10Wt4Rg/viewform?embedded=true"
                width="100%" height="` + altura + `" frameborder="0" marginheight="0" marginwidth="0"
                style="background:#fff;border-radius:12px;box-shadow:0 2px 12px #2d6cdf22;min-height:400px;max-height:90vh;">
                Cargando…
              </iframe>
            `;
          }
          // Si es el botón de Tarifario (índice 4)
          if (idx === 4) {
            document.getElementById('adminContentBox').style.display = 'flex';
            var altura = Math.max(window.innerHeight * 0.85, 600);
            document.getElementById('adminContentArea').innerHTML = `
              <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeKUqZFXZ5pi7CrcfwJUEQCg0Bd1F2GGrEnyPtDbwLn_ohOeQ/viewform?embedded=true"
                width="100%" height="` + altura + `" frameborder="0" marginheight="0" marginwidth="0"
                style="background:#fff;border-radius:12px;box-shadow:0 2px 12px #2d6cdf22;min-height:400px;max-height:90vh;">
                Cargando…
              </iframe>
            `;
          }
          // Si es el botón de Inventarios (índice 5)
          if (idx === 5) {
            window.open('https://forms.gle/1v5GDLaJ1FNVZny26', '_blank');
            return;
          }
          if (window.innerWidth <= 700) {
            empleadoPanel.style.transition = 'left 0.7s cubic-bezier(.77,0,.18,1), box-shadow 0.3s';
            empleadoPanel.classList.add('closing');
            setTimeout(() => {
              empleadoPanel.classList.remove('active');
              empleadoPanel.style.display = 'none';
              hamburgerBtn.classList.remove('active');
              document.body.classList.remove('sidebar-open');
              empleadoPanel.classList.remove('closing');
              empleadoPanel.style.transition = '';
            }, 600);
          } else {
            empleadoPanel.classList.remove('active');
            sidebarVisible = false;
          }
        });
      });

      // --- FUNCIONALIDAD BOTONES ADMIN ---
      document.querySelectorAll('#adminPanel .sidebar-btn').forEach(function(btn, idx) {
        btn.addEventListener('click', async function () {
          // Oculta el mensaje de "Selecciona una función del panel lateral"
          var msg = document.querySelector('#adminContentBox > div');
          if (msg) msg.style.display = 'none';

          // CREAR USUARIO (índice 0)
          if (idx === 0) {
            document.getElementById('adminContentBox').style.display = 'flex';
            document.getElementById('adminContentArea').innerHTML = `
              <div style="display:flex;justify-content:center;align-items:center;min-height:50vh;width:100%;">
                <form id="crear-usuario-form"
                  style="
                    width:100%;
                    max-width:340px;
                    margin:0 auto;
                    display:flex;
                    flex-direction:column;
                    gap:1rem;
                    background:linear-gradient(120deg,#fafdff 70%,#e2eaff 100%);
                    border-radius:18px;
                    box-shadow:0 4px 18px #2d6cdf22;
                    padding:1.3rem 1.1rem 1rem 1.1rem;
                    align-items:center;
                    border:2px solid #b3c6e0;
                    ">
                  <h2 style="color:#2266bb;text-align:center;margin-bottom:0.4rem;font-size:1.15rem;font-weight:800;letter-spacing:1px;text-shadow:0 2px 8px #b3c6e022;">Crear usuario</h2>
                  <label style="font-weight:600;color:#2266bb;width:100%;max-width:220px;display:flex;flex-direction:column;gap:0.2rem;">
                    Nombre
                    <input type="text" id="nuevo-nombre" required placeholder="Nombre"
                      style="width:100%;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;background:linear-gradient(90deg,#eaf2fb 0%,#f7faff 100%);color:#2266bb;">
                  </label>
                  <label style="font-weight:600;color:#2266bb;width:100%;max-width:220px;display:flex;flex-direction:column;gap:0.2rem;">
                    NIP
                    <input type="password" id="nuevo-nip" required placeholder="NIP" minlength="4" maxlength="12"
                      style="width:100%;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;background:linear-gradient(90deg,#eaf2fb 0%,#f7faff 100%);color:#2266bb;">
                  </label>
                  <label style="font-weight:600;color:#2266bb;width:100%;max-width:220px;display:flex;flex-direction:column;gap:0.2rem;">
                    Rol
                    <select id="nuevo-rol" required
                      style="width:100%;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;background:linear-gradient(90deg,#eaf2fb 0%,#f7faff 100%);color:#2266bb;">
                      <option value="">Selecciona</option>
                      <option value="empleado">Empleado</option>
                      <option value="admin">Admin</option>
                    </select>
                  </label>
                  <label style="font-weight:600;color:#2266bb;width:100%;max-width:220px;display:flex;flex-direction:column;gap:0.2rem;">
                    Activo
                    <select id="nuevo-activo" required
                      style="width:100%;padding:0.6rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;text-align:center;background:linear-gradient(90deg,#eaf2fb 0%,#f7faff 100%);color:#2266bb;">
                      <option value="true">Sí</option>
                      <option value="false">No</option>
                    </select>
                  </label>
                  <button type="submit"
                    style="padding:0.7rem 0;background:linear-gradient(90deg,#1656b7 0%,#2d6cdf 100%);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:1.08rem;cursor:pointer;box-shadow:0 2px 8px #2d6cdf22;transition:background 0.2s;width:100%;max-width:160px;margin:0.5rem auto 0 auto;letter-spacing:1px;">
                    Crear
                  </button>
                  <div id="crear-usuario-msg" style="margin-top:0.5rem;font-size:0.98rem;text-align:center;min-height:1.2em;"></div>
                </form>
              </div>
            `;
            setTimeout(function() {
              document.getElementById('crear-usuario-form').onsubmit = async function(e) {
                e.preventDefault();
                const nombre = document.getElementById('nuevo-nombre').value.trim();
                const nip = document.getElementById('nuevo-nip').value.trim();
                const rol = document.getElementById('nuevo-rol').value;
                const activo = document.getElementById('nuevo-activo').value === 'true';
                const msgDiv = document.getElementById('crear-usuario-msg');
                msgDiv.textContent = '';
                msgDiv.style.color = '#2266bb';

                if (!nombre || !nip || !rol) {
                  msgDiv.textContent = 'Todos los campos son obligatorios.';
                  msgDiv.style.color = '#d32f2f';
                  return;
                }

                // Verifica si ya existe el usuario
                const { data: existe, error: errorExiste } = await supabase
                  .from('usuarios')
                  .select('id')
                  .eq('nombre', nombre)
                  .maybeSingle();

                if (errorExiste) {
                  msgDiv.textContent = 'Error de conexión.';
                  msgDiv.style.color = '#d32f2f';
                  return;
                }
                if (existe) {
                  msgDiv.textContent = 'Ya existe un usuario con ese nombre.';
                  msgDiv.style.color = '#d32f2f';
                  return;
                }

                // Inserta el usuario
                const { error } = await supabase
                  .from('usuarios')
                  .insert([{ nombre, nip, rol, activo }]);

                if (error) {
                  msgDiv.textContent = 'Error al crear usuario.';
                  msgDiv.style.color = '#d32f2f';
                } else {
                  msgDiv.textContent = 'Usuario creado correctamente.';
                  msgDiv.style.color = '#388e3c';
                  document.getElementById('crear-usuario-form').reset();
                }
              };
            }, 50);
          }
          // Si es el botón de Ver usuarios (índice 1)
          if (idx === 1) {
            document.getElementById('adminContentBox').style.display = 'flex';
            const area = document.getElementById('adminContentArea');
            area.innerHTML = `<div style="text-align:center;color:#2266bb;font-weight:700;font-size:1.1rem;margin-bottom:1rem;">Cargando usuarios...</div>`;
            // Obtener usuarios de Supabase
            const { data: usuarios, error } = await supabase
              .from('usuarios')
              .select('id,nombre,rol,activo')
              .order('nombre', { ascending: true });
            if (error) {
              area.innerHTML = `<div style="color:#d32f2f;text-align:center;">Error al cargar usuarios.</div>`;
              return;
            }
            if (!usuarios || usuarios.length === 0) {
              area.innerHTML = `<div style="color:#888;text-align:center;">No hay usuarios registrados.</div>`;
              return;
            }
            // Renderizar tabla
            area.innerHTML = `
              <div style="overflow-x:auto;">
                <table style="width:100%;max-width:520px;margin:0 auto;border-collapse:separate;border-spacing:0;background:#fff;border-radius:18px;box-shadow:0 2px 12px #2d6cdf18;overflow:hidden;">
                  <thead>
                    <tr style="
                      background: linear-gradient(90deg, #2266bb 0%, #4fa3f7 100%);
                      color: #fff;
                      font-weight:900;
                      font-size:1.08rem;
                      letter-spacing:0.5px;
                      border-bottom: 3px solid #1656b7;
                      box-shadow: 0 2px 8px #2d6cdf33;
                    ">
                      <th style="padding:0.85rem 0.5rem;border-bottom:2.5px solid #b3c6e0; border-top-left-radius:18px;">Nombre</th>
                      <th style="padding:0.85rem 0.5rem;border-bottom:2.5px solid #b3c6e0;">Rol</th>
                      <th style="padding:0.85rem 0.5rem;border-bottom:2.5px solid #b3c6e0;">Activo</th>
                      <th style="padding:0.85rem 0.5rem;border-bottom:2.5px solid #b3c6e0; border-top-right-radius:18px;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${usuarios.map((u, idx) => `
                      <tr data-id="${u.id}" style="border-bottom:1px solid #eaf2fb;">
                        <td style="padding:0.6rem 0.5rem;text-align:center;">${u.nombre}</td>
                        <td style="padding:0.6rem 0.5rem;text-align:center;">${u.rol}</td>
                        <td style="padding:0.6rem 0.5rem;text-align:center;">
                          <span style="color:${u.activo ? '#388e3c' : '#d32f2f'};font-weight:700;">
                            ${u.activo ? 'Sí' : 'No'}
                          </span>
                        </td>
                        <td style="padding:0.6rem 0.5rem;text-align:center;">
                          <button class="toggle-activo-btn" style="background:${u.activo ? '#d32f2f' : '#388e3c'};color:#fff;border:none;border-radius:7px;padding:0.3rem 0.8rem;font-weight:700;cursor:pointer;margin-right:0.5rem;">
                            ${u.activo ? 'Desactivar' : 'Activar'}
                          </button>
                          <button class="eliminar-usuario-btn" style="background:#b71c1c;color:#fff;border:none;border-radius:7px;padding:0.3rem 0.8rem;font-weight:700;cursor:pointer;">
                            Eliminar
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              <div id="usuarios-msg" style="margin-top:1rem;font-size:1rem;text-align:center;min-height:1.2em;"></div>
            `;
            // Botones de activar/desactivar
            area.querySelectorAll('.toggle-activo-btn').forEach(function(btn) {
              btn.onclick = async function() {
                const tr = btn.closest('tr');
                const id = tr.getAttribute('data-id');
                const activoActual = btn.textContent.trim() === 'Desactivar';
                btn.disabled = true;
                btn.textContent = '...';
                const { error } = await supabase
                  .from('usuarios')
                  .update({ activo: !activoActual })
                  .eq('id', id);
                if (error) {
                  document.getElementById('usuarios-msg').textContent = 'Error al actualizar usuario.';
                  document.getElementById('usuarios-msg').style.color = '#d32f2f';
                } else {
                  // Refrescar la tabla
                  document.querySelector('#adminPanel .sidebar-btn:nth-child(2)').click();
                }
              };
            });
            // Botones de eliminar
            area.querySelectorAll('.eliminar-usuario-btn').forEach(function(btn) {
              btn.onclick = async function() {
                if (!confirm('¿Seguro que deseas eliminar este usuario? Esta acción no se puede deshacer.')) return;
                const tr = btn.closest('tr');
                const id = tr.getAttribute('data-id');
                btn.disabled = true;
                btn.textContent = '...';
                const { error } = await supabase
                  .from('usuarios')
                  .delete()
                  .eq('id', id);
                if (error) {
                  document.getElementById('usuarios-msg').textContent = 'Error al eliminar usuario.';
                  document.getElementById('usuarios-msg').style.color = '#d32f2f';
                } else {
                  // Refrescar la tabla
                  document.querySelector('#adminPanel .sidebar-btn:nth-child(2)').click();
                }
              };
            });
          }
          //Sidebar cierre en móvil igual que otros
            if (window.innerWidth <= 700) {
              adminPanel.style.transition = 'left 0.7s cubic-bezier(.77,0,.18,1), box-shadow 0.3s';
              adminPanel.classList.add('closing');
              setTimeout(() => {
                adminPanel.classList.remove('active');
                hamburgerBtn.classList.remove('active');
                document.body.classList.remove('sidebar-open');
                adminPanel.classList.remove('closing');
                adminPanel.style.transition = '';
              }, 600);
            } else {
              adminPanel.classList.remove('active');
              sidebarVisible = false;
            }
          // AVISO (índice 3)
            if (idx === 3) {
            document.getElementById('adminContentBox').style.display = 'flex';
            document.getElementById('adminContentArea').innerHTML = `
              <div style="display:flex;justify-content:center;align-items:center;min-height:50vh;width:100%;">
              <form id="crear-aviso-form"
              style="
              width:100%;
              max-width:480px;
              margin:0 auto;
              display:flex;
              flex-direction:column;
              gap:1.3rem;
              background:linear-gradient(120deg,#fafdff 70%,#e2eaff 100%);
              border-radius:22px;
              box-shadow:0 8px 32px #2d6cdf22, 0 2px 12px #ff980033;
              padding:2.2rem 1.5rem 1.5rem 1.5rem;
              align-items:center;
              border:2.5px solid #2266bb;
              position:relative;
              ">
              <div style="position:absolute;top:-32px;left:50%;transform:translateX(-50%);background:linear-gradient(120deg,#2266bb 60%,#4fa3f7 100%);border-radius:50%;width:64px;height:64px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px #2266bb33;">
              <svg width="38" height="38" viewBox="0 0 24 24" fill="none">
                <path d="M12 9v4" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="17" r="1.3" fill="#fff"/>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="#fff" stroke-width="2"/>
              </svg>
              </div>
              <h2 style="color:#2266bb;text-align:center;margin-bottom:0.2rem;font-size:1.35rem;font-weight:900;letter-spacing:1.2px;text-shadow:0 2px 8px #b3c6e022;">Nuevo aviso</h2>
              <label style="font-weight:700;color:#1656b7;width:100%;max-width:340px;display:flex;flex-direction:column;gap:0.3rem;">
              <span style="margin-bottom:0.1rem;">Texto del aviso</span>
              <textarea id="aviso-texto" required placeholder="Escribe el aviso..." rows="4"
                style="width:100%;padding:1rem 1rem;border-radius:12px;border:2px solid #b3c6e0;font-size:1.08rem;background:linear-gradient(90deg,#eaf2fb 0%,#f7faff 100%);color:#2266bb;resize:vertical;min-height:80px;box-shadow:0 2px 8px #2d6cdf11;transition:border 0.2s,box-shadow 0.2s;">
              </textarea>
              </label>
              <label style="font-weight:700;color:#1656b7;width:100%;max-width:220px;display:flex;flex-direction:column;gap:0.3rem;">
              <span style="margin-bottom:0.1rem;">Sucursal</span>
              <select id="aviso-sucursal" required
                style="width:100%;padding:0.8rem 0.7rem;border-radius:10px;border:2px solid #b3c6e0;font-size:1.08rem;background:linear-gradient(90deg,#eaf2fb 0%,#f7faff 100%);color:#2266bb;box-shadow:0 2px 8px #2d6cdf11;transition:border 0.2s,box-shadow 0.2s;">
                <option value="">Selecciona</option>
                <option value="TODAS">TODAS</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
              </select>
              </label>
              <button type="submit"
              style="padding:1rem 0;background:linear-gradient(90deg,#1656b7 0%,#2d6cdf 100%);color:#fff;border:none;border-radius:12px;font-weight:800;font-size:1.15rem;cursor:pointer;box-shadow:0 2px 12px #2d6cdf22;transition:background 0.2s;width:100%;max-width:180px;margin:0.7rem auto 0 auto;letter-spacing:1.2px;">
              Crear aviso
              </button>
              <div id="crear-aviso-msg" style="margin-top:0.7rem;font-size:1.05rem;text-align:center;min-height:1.2em;font-weight:700;"></div>
              </form>
              </div>
              <div id="avisos-activos-area" style="margin-top:2.5rem;"></div>
            `;
            setTimeout(function() {
              // Al enfocar el textarea, poner el cursor al inicio
              var avisoTextarea = document.getElementById('aviso-texto');
              if (avisoTextarea) {
              avisoTextarea.addEventListener('focus', function() {
                // Selecciona desde el inicio
                this.setSelectionRange(0, 0);
              });
              // También al hacer click, si no hay selección, pon el cursor al inicio
              avisoTextarea.addEventListener('mousedown', function(e) {
                if (document.activeElement !== this) {
                setTimeout(() => this.setSelectionRange(0, 0), 1);
                }
              });
              }

              document.getElementById('crear-aviso-form').onsubmit = async function(e) {
              e.preventDefault();
              const texto = document.getElementById('aviso-texto').value.trim();
              const sucursal = document.getElementById('aviso-sucursal').value;
              const msgDiv = document.getElementById('crear-aviso-msg');
              msgDiv.textContent = '';
              msgDiv.style.color = '#2266bb';
              if (!texto || !sucursal) {
              msgDiv.textContent = 'Todos los campos son obligatorios.';
              msgDiv.style.color = '#d32f2f';
              return;
              }
              const { error } = await supabase
              .from('avisos')
              .insert([{ texto, sucursal }]);
              if (error) {
              msgDiv.textContent = 'Error al crear aviso.';
              msgDiv.style.color = '#d32f2f';
              } else {
              msgDiv.textContent = 'Aviso creado correctamente.';
              msgDiv.style.color = '#388e3c';
              document.getElementById('crear-aviso-form').reset();
              cargarAvisosActivos(); // Refresca la lista de avisos activos
              }
              };

              // Función para cargar avisos activos y permitir eliminarlos
              async function cargarAvisosActivos() {
              const area = document.getElementById('avisos-activos-area');
              area.innerHTML = `<div style="color:#2266bb;font-weight:700;font-size:1.1rem;text-align:center;margin-bottom:1rem;">Cargando avisos activos...</div>`;
              const { data: avisos, error } = await supabase
              .from('avisos')
              .select('id,sucursal,texto,created_at')
              .order('id', { ascending: false });
              if (error) {
              area.innerHTML = `<div style="color:#d32f2f;text-align:center;">Error al cargar avisos.</div>`;
              return;
              }
              if (!avisos || avisos.length === 0) {
              area.innerHTML = `<div style="color:#888;text-align:center;">No hay avisos activos.</div>`;
              return;
              }
              area.innerHTML = `
              <h3 style="color:#2266bb;font-size:1.15rem;font-weight:900;text-align:center;margin-bottom:1.1rem;">Avisos activos</h3>
              <div style="display:flex;flex-direction:column;gap:1.1rem;max-width:600px;margin:0 auto;">
              ${avisos.map(aviso => `
                <div style="background:#fafdff;border:2px solid #b3c6e0;border-radius:12px;padding:1rem 1.1rem;box-shadow:0 2px 8px #2d6cdf11;position:relative;">
                <div style="font-weight:700;color:#2266bb;font-size:1.08rem;margin-bottom:0.3rem;">
                ${aviso.sucursal === "TODAS" ? "Todas las sucursales" : "Sucursal: " + aviso.sucursal}
                <span style="float:right;font-size:0.98rem;color:#888;font-weight:400;">${new Date(aviso.created_at).toLocaleString('es-MX')}</span>
                </div>
                <div style="font-size:1.08rem;color:#1656b7;margin-bottom:0.4rem;white-space:pre-line;">${aviso.texto}</div>
                <button class="eliminar-aviso-btn" data-id="${aviso.id}" style="background:#d32f2f;color:#fff;border:none;border-radius:7px;padding:0.4rem 1.1rem;font-weight:700;cursor:pointer;font-size:1rem;position:absolute;top:1rem;right:1rem;">Eliminar</button>
                </div>
              `).join('')}
              </div>
              <div id="avisos-activos-msg" style="margin-top:1rem;font-size:1rem;text-align:center;min-height:1.2em;"></div>
              `;
              // Botones eliminar aviso
              area.querySelectorAll('.eliminar-aviso-btn').forEach(function(btn) {
              btn.onclick = async function() {
              if (!confirm('¿Seguro que deseas eliminar este aviso?')) return;
              const avisoId = btn.getAttribute('data-id');
              btn.disabled = true;
              btn.textContent = '...';
              const { error } = await supabase
                .from('avisos')
                .delete()
                .eq('id', avisoId);
              if (error) {
                document.getElementById('avisos-activos-msg').textContent = 'Error al eliminar aviso.';
                document.getElementById('avisos-activos-msg').style.color = '#d32f2f';
              } else {
                cargarAvisosActivos();
              }
              };
              });
              }

              // Cargar avisos activos al abrir el panel
              cargarAvisosActivos();
            }, 50);
            // Sidebar cierre en móvil igual que otros
            if (window.innerWidth <= 700) {
              adminPanel.style.transition = 'left 0.7s cubic-bezier(.77,0,.18,1), box-shadow 0.3s';
              adminPanel.classList.add('closing');
              setTimeout(() => {
                adminPanel.classList.remove('active');
                hamburgerBtn.classList.remove('active');
                document.body.classList.remove('sidebar-open');
                adminPanel.classList.remove('closing');
                adminPanel.style.transition = '';
              }, 600);
            } else {
              adminPanel.classList.remove('active');
              sidebarVisible = false;
            }
            return;
          }
          // Si es el botón de Checadas (índice 2)
                // Si es el botón de Checadas (índice 2)
                if (idx === 2) {
                  document.getElementById('adminContentBox').style.display = 'flex';
                  const area = document.getElementById('adminContentArea');
                  area.innerHTML = `
                  <div style="text-align:center;color:#2266bb;font-weight:700;font-size:1.1rem;margin-bottom:1rem;">
                    Filtro de checadas por rango de fechas
                  </div>
                  <form id="filtro-checadas-form" style="display:flex;gap:1.2rem;justify-content:center;align-items:center;margin-bottom:1.2rem;flex-wrap:wrap;">
                    <label style="font-weight:600;color:#2266bb;">
                    Desde
                    <input type="date" id="checada-fecha-inicio" required style="margin-left:0.4rem;padding:0.4rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;">
                    </label>
                    <label style="font-weight:600;color:#2266bb;">
                    Hasta
                    <input type="date" id="checada-fecha-fin" required style="margin-left:0.4rem;padding:0.4rem 0.7rem;border-radius:8px;border:1.5px solid #b3c6e0;font-size:1rem;">
                    </label>
                    <button type="submit" style="padding:0.6rem 1.2rem;background:linear-gradient(90deg,#1656b7 0%,#2d6cdf 100%);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 2px 8px #2d6cdf22;">Buscar</button>
                    <button type="button" id="exportar-csv-btn" style="padding:0.6rem 1.2rem;background:linear-gradient(90deg,#4fa3f7 0%,#2266bb 100%);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 2px 8px #2d6cdf22;">Exportar CSV</button>
                  </form>
                  <div id="checadas-resultados"></div>
                  `;

                  // Set default dates (last 7 days)
                  const hoy = new Date();
                  const hace7 = new Date();
                  hace7.setDate(hoy.getDate() - 7);
                  document.getElementById('checada-fecha-inicio').value = hace7.toISOString().slice(0, 10);
                  document.getElementById('checada-fecha-fin').value = hoy.toISOString().slice(0, 10);

                  let checadasUltimaConsulta = [];

                  async function cargarChecadasPorRango(fechaInicio, fechaFin) {
                    const resultadosDiv = document.getElementById('checadas-resultados');
                    resultadosDiv.innerHTML = `<div style="text-align:center;color:#2266bb;font-weight:700;font-size:1.1rem;margin-bottom:1rem;">Cargando checadas...</div>`;
                    // Query checadas en el rango
                    const { data: checadas, error } = await supabase
                      .from('checadas')
                      .select('id, nombre, sucursal, fecha, hora, tipo, t2')
                      .gte('fecha', fechaInicio)
                      .lte('fecha', fechaFin);

                    // Ordenar: 1) fecha DESC, 2) nombre ASC, 3) hora DESC
                    let checadasOrdenadas = (checadas || []).slice().sort((a, b) => {
                      // 1. Fecha menor a mayor
                      if (a.fecha !== b.fecha) {
                        return a.fecha.localeCompare(b.fecha);
                      }
                      // 2. Usuario (nombre) ascendente
                      if ((a.nombre || '').toLowerCase() !== (b.nombre || '').toLowerCase()) {
                        return (a.nombre || '').toLowerCase().localeCompare((b.nombre || '').toLowerCase());
                      }
                      // 3. Hora menor a mayor
                      // Usar parseChecadaToDate para comparar correctamente
                      const dateA = parseChecadaToDate(a.fecha, a.hora);
                      const dateB = parseChecadaToDate(b.fecha, b.hora);
                      if (dateA && dateB) {
                        return dateA - dateB;
                      }
                      // fallback por si no se puede parsear
                      return (a.hora || '').localeCompare(b.hora || '');
                    });
                

                    checadasUltimaConsulta = checadasOrdenadas;

                    if (error) {
                      resultadosDiv.innerHTML = `<div style="color:#d32f2f;text-align:center;">Error al cargar checadas.</div>`;
                      return;
                    }
                    if (!checadasOrdenadas || checadasOrdenadas.length === 0) {
                      resultadosDiv.innerHTML = `<div style="color:#888;text-align:center;">No hay checadas en ese rango.</div>`;
                      return;
                    }
                    resultadosDiv.innerHTML = `
                      <div style="overflow-x:auto; padding: 0.5rem;">
                      <div style="max-height:420px;overflow-y:auto;border-radius:12px;box-shadow:0 4px 20px rgba(45,108,223,0.10);">
                        <table style="width:100%; max-width:900px; margin:0 auto; border-collapse:separate; border-spacing:0; background:#fff; border-radius:12px; font-size: 0.97rem; min-width:740px; position:relative;">
                        <thead style="position:sticky;top:0;z-index:3;background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%);">
                          <tr>
                          <th style="padding:1rem 0.8rem; text-align:left; border-bottom:2.5px solid #b3c6e0; border-top-left-radius:12px; min-width:120px; background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%); color:#fff; position:sticky; top:0; z-index:4;">Usuario</th>
                          <th style="padding:1rem 0.8rem; text-align:center; border-bottom:2.5px solid #b3c6e0; min-width:80px; background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%); color:#fff; position:sticky; top:0; z-index:4;">Sucursal</th>
                          <th style="padding:1rem 0.8rem; text-align:center; border-bottom:2.5px solid #b3c6e0; min-width:110px; background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%); color:#fff; position:sticky; top:0; z-index:4;">Fecha</th>
                          <th style="padding:1rem 0.8rem; text-align:center; border-bottom:2.5px solid #b3c6e0; min-width:100px; background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%); color:#fff; position:sticky; top:0; z-index:4;">Hora</th>
                          <th style="padding:1rem 0.8rem; text-align:center; border-bottom:2.5px solid #b3c6e0; min-width:100px; background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%); color:#fff; position:sticky; top:0; z-index:4;">Acción</th>
                          <th style="padding:1rem 0.8rem; text-align:center; border-bottom:2.5px solid #b3c6e0; border-top-right-radius:12px; min-width:100px; background: linear-gradient(135deg, #2d6cdf 0%, #4fa3f7 100%); color:#fff; position:sticky; top:0; z-index:4;">Tipo</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${checadasOrdenadas.map((c, index) => `
                          <tr style="border-bottom:1px solid #f0f4f9; background-color: ${index % 2 === 0 ? '#fdfeff' : '#f7faff'}; transition: background-color 0.2s;">
                            <td style="padding:0.85rem 0.8rem; text-align:left; color: #33475b; font-weight:600;">${c.nombre}</td>
                            <td style="padding:0.85rem 0.8rem; text-align:center; color: #50667d;">${c.sucursal || ''}</td>
                            <td style="padding:0.85rem 0.8rem; text-align:center; color: #50667d;">${new Date(c.fecha + 'T00:00:00').toLocaleDateString('es-MX', {timeZone: 'UTC'})}</td>
                            <td style="padding:0.85rem 0.8rem; text-align:center; color: #50667d;">${formatDateToDisplayHora(parseChecadaToDate(c.fecha, c.hora))}</td>
                            <td style="padding:0.85rem 0.8rem; text-align:center;">
                            <span style="
                              padding: 0.35rem 0.8rem;
                              border-radius: 16px;
                              font-size: 0.98rem;
                              font-weight:700;
                              color: #fff;
                              background-color:${c.tipo === 'entrada' ? '#388e3c' : '#d32f2f'};
                              box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                            ">
                              ${c.tipo === 'entrada' ? 'Entrada' : 'Salida'}
                            </span>
                            </td>
                            <td style="padding:0.85rem 0.8rem; text-align:center;">
                            <span style="
                              padding: 0.35rem 0.8rem;
                              border-radius: 16px;
                              font-size: 0.98rem;
                              font-weight:700;
                              color: #fff;
                              background-color:${c.t2 === 'TURNO' ? '#1656b7' : (c.t2 === 'COMIDA' ? '#ff9800' : '#888')};
                              box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                            ">
                              ${c.t2 ? c.t2 : ''}
                            </span>
                            </td>
                          </tr>
                          `).join('')}
                        </tbody>
                        </table>
                      </div>
                      </div>
                    `;
                  }

                  // Cargar checadas por defecto (últimos 7 días)
                  cargarChecadasPorRango(
                    document.getElementById('checada-fecha-inicio').value,
                    document.getElementById('checada-fecha-fin').value
                  );

                  document.getElementById('filtro-checadas-form').onsubmit = function(e) {
                    e.preventDefault();
                    const inicio = document.getElementById('checada-fecha-inicio').value;
                    const fin = document.getElementById('checada-fecha-fin').value;
                    if (!inicio || !fin) return;
                    if (inicio > fin) {
                      alert('La fecha de inicio no puede ser mayor que la fecha de fin.');
                      return;
                    }
                    cargarChecadasPorRango(inicio, fin);
                  };

                  // Exportar a CSV
                  document.getElementById('exportar-csv-btn').onclick = function() {
                    if (!checadasUltimaConsulta || checadasUltimaConsulta.length === 0) {
                      alert('No hay datos para exportar.');
                      return;
                    }
                    // Encabezados
                    const headers = ['Usuario', 'Sucursal', 'Fecha', 'Hora', 'Acción', 'Tipo'];
                    // Filas
                    const rows = checadasUltimaConsulta.map(c => [
                      `"${c.nombre}"`,
                      `"${c.sucursal || ''}"`,
                      `"${new Date(c.fecha + 'T00:00:00').toLocaleDateString('es-MX', {timeZone: 'UTC'})}"`,
                      `"${formatDateToDisplayHora(parseChecadaToDate(c.fecha, c.hora))}"`,
                      `"${c.tipo === 'entrada' ? 'Entrada' : 'Salida'}"`,
                      `"${c.t2 ? c.t2 : ''}"`
                    ]);
                    // Unir todo
                    let csvContent = headers.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
                    // Descargar
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'checadas.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                  };
                }
        // ...existing code...
          // ...otros botones admin aquí (índices 1, 2, 3)...
        });
      });

      // --- NUEVO: Función para actualizar visualmente el estado del Check IN ---
      function actualizarEstadoCheckInVisual(realizado, horaOriginalStr, fechaOriginalStr = null) {
        const statusEl = document.getElementById('checkin-status');
        if (realizado) { 
          let mensaje = 'CHECK IN: Realizado';
          if (horaOriginalStr) {
            const fechaParaParseo = fechaOriginalStr || getFechaLocal(); // Usar fecha actual si no se provee
            const dateObj = parseChecadaToDate(fechaParaParseo, horaOriginalStr);
            if (dateObj) {
                mensaje += ` ${formatDateToDisplayHora(dateObj)}`;
            } else {
                mensaje += ` ${horaOriginalStr}`; // Fallback
            }
          }
          statusEl.textContent = mensaje;
          statusEl.classList.remove('no-realizado');
          statusEl.classList.add('realizado');
        } else {
          statusEl.textContent = 'CHECK IN: No realizado';
          statusEl.classList.remove('realizado');
          statusEl.classList.add('no-realizado');
        }
      }

      // --- NUEVO: Función para obtener fecha local en formato YYYY-MM-DD ---
      function getFechaLocal() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // --- NUEVO: Función para obtener hora local en formato HH:MM:SS ---
      function getHoraLocal() {
        const now = new Date();
        const hours = now.getHours(); // 0-23
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        
        const hoursStr = hours.toString().padStart(2, '0');
        const minutesStr = minutes.toString().padStart(2, '0');
        const secondsStr = seconds.toString().padStart(2, '0');
        
        return `${hoursStr}:${minutesStr}:${secondsStr}`; // Formato HH:MM:SS
      }

      // --- NUEVO: Función para parsear y formatear hora para visualización ---
      function parseHoraParaVisualizacion(horaStr) {
        if (!horaStr || typeof horaStr !== 'string') {
            console.warn("parseHoraParaVisualizacion: horaStr inválido", horaStr);
            return ""; // O devolver un valor por defecto o lanzar error
        }
        let date = new Date(); // Default to now, time parts will be overwritten

        if (horaStr.toLowerCase().includes('m.')) { // Detecta a.m. o p.m.
            const [timePart, ampmPart] = horaStr.split(' '); 
            if (!timePart || !ampmPart) {
                 console.warn("Formato de hora (am/pm) no reconocido:", horaStr);
                 return horaStr;
            }
            const [hoursStr, minutesStr, secondsStr] = timePart.split(':');
            let hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr, 10);
            const seconds = secondsStr ? parseInt(secondsStr, 10) : 0;

            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                console.warn("Partes de hora (am/pm) inválidas:", horaStr);
                return horaStr;
            }

            if (ampmPart.toLowerCase() === 'p.m.' && hours < 12) hours += 12;
            if (ampmPart.toLowerCase() === 'a.m.' && hours === 12) hours = 0; // 12 a.m. es 00 horas
            date.setHours(hours, minutes, seconds, 0);
        } else if (horaStr.includes(':')) { // Asume HH:MM:SS o HH:MM
            const parts = horaStr.split(':');
            const h = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            const s = parts[2] ? parseInt(parts[2], 10) : 0;

            if (isNaN(h) || isNaN(m) || isNaN(s)) {
                console.warn("Partes de hora (24h) inválidas:", horaStr);
                return horaStr;
            }
            date.setHours(h, m, s, 0);
        } else {
            console.warn("Formato de hora no reconocido en parseHoraParaVisualizacion:", horaStr);
            return horaStr; 
        }
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); // Formato de visualización ej: 02:30 PM
      }


      // --- NUEVO: Funcionalidad botones ENTRADA/SALIDA ---
      const btnEntrada = document.querySelector('#empleadoPanel .entrada-btn');
      const btnSalida = document.querySelector('#empleadoPanel .salida-btn');

      if (btnEntrada) {
        btnEntrada.addEventListener('click', async () => {
          if (!empleadoNombre || !empleadoSucursal) {
        alert('Error: No se ha identificado al empleado o sucursal.');
        return;
          }

          // --- FILTRO: Revisar si ya hay una entrada en los últimos 30 minutos ---
          const ahora = new Date();
          const hace30min = new Date(ahora.getTime() - 30 * 60 * 1000);

          // Buscar checadas de entrada de este usuario en los últimos 2 días (por si cruza medianoche)
          const { data: checadasRecientes, error: errorChecadas } = await supabase
        .from('checadas')
        .select('fecha, hora, tipo')
        .eq('usuario_id', empleadoId)
        .eq('tipo', 'entrada')
        .order('fecha', { ascending: false })
        .order('hora', { ascending: false })
        .limit(10);

          if (!errorChecadas && checadasRecientes && checadasRecientes.length > 0) {
        // Buscar si alguna entrada fue en los últimos 30 minutos
        const entradaReciente = checadasRecientes.find(c => {
          const entradaDate = parseChecadaToDate(c.fecha, c.hora);
          return entradaDate && entradaDate > hace30min;
        });
        if (entradaReciente) {
          alert('Ya registraste una entrada en los últimos 30 minutos. Espera antes de registrar otra.');
          return;
        }
          }

          // Crear botones flotantes TURNO y COMIDA
          let overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.background = 'rgba(34,102,187,0.10)';
          overlay.style.zIndex = '99999';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';

          let box = document.createElement('div');
          box.style.background = '#fff';
          box.style.borderRadius = '18px';
          box.style.boxShadow = '0 8px 32px #2d6cdf22, 0 2px 12px #ff980033';
          box.style.padding = '2.2rem 2.5rem 2rem 2.5rem';
          box.style.display = 'flex';
          box.style.flexDirection = 'column';
          box.style.alignItems = 'center';
          box.style.gap = '1.5rem';
          box.style.minWidth = '220px';

          let title = document.createElement('div');
          title.textContent = 'Selecciona tipo de entrada';
          title.style.fontWeight = '900';
          title.style.fontSize = '1.18rem';
          title.style.color = '#2266bb';
          title.style.marginBottom = '0.7rem';
          box.appendChild(title);

          let btnTurno = document.createElement('button');
          btnTurno.textContent = 'TURNO';
          btnTurno.style.background = 'linear-gradient(90deg,#1656b7 0%,#2d6cdf 100%)';
          btnTurno.style.color = '#fff';
          btnTurno.style.border = 'none';
          btnTurno.style.borderRadius = '12px';
          btnTurno.style.fontWeight = '800';
          btnTurno.style.fontSize = '1.15rem';
          btnTurno.style.padding = '1.1rem 2.5rem';
          btnTurno.style.cursor = 'pointer';
          btnTurno.style.boxShadow = '0 2px 8px #2d6cdf22';
          btnTurno.style.marginBottom = '0.5rem';

          let btnComida = document.createElement('button');
          btnComida.textContent = 'INICIO COMIDA';
          btnComida.style.background = 'linear-gradient(90deg,#ff9800 0%,#fbc02d 100%)';
          btnComida.style.color = '#fff';
          btnComida.style.border = 'none';
          btnComida.style.borderRadius = '12px';
          btnComida.style.fontWeight = '800';
          btnComida.style.fontSize = '1.15rem';
          btnComida.style.padding = '1.1rem 2.5rem';
          btnComida.style.cursor = 'pointer';
          btnComida.style.boxShadow = '0 2px 8px #ff980033';

          let btnCancelar = document.createElement('button');
          btnCancelar.textContent = 'Cancelar';
          btnCancelar.style.background = '#d32f2f';
          btnCancelar.style.color = '#fff';
          btnCancelar.style.border = 'none';
          btnCancelar.style.borderRadius = '10px';
          btnCancelar.style.fontWeight = '700';
          btnCancelar.style.fontSize = '1rem';
          btnCancelar.style.padding = '0.7rem 1.5rem';
          btnCancelar.style.cursor = 'pointer';
          btnCancelar.style.marginTop = '1.2rem';

          box.appendChild(btnTurno);
          box.appendChild(btnComida);
          box.appendChild(btnCancelar);
          overlay.appendChild(box);
          document.body.appendChild(overlay);

          function registrarEntrada(t2Value) {
        const fecha = getFechaLocal();
        const hora = getHoraLocal(); // HH:MM:SS

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const ubicacionSucursal = SUCURSALES_UBICACION[empleadoSucursal];
          if (!ubicacionSucursal) {
            alert('No hay ubicación registrada para tu sucursal.');
            document.body.removeChild(overlay);
            return;
          }
          const distancia = distanciaMetros(lat, lng, ubicacionSucursal.lat, ubicacionSucursal.lng);
          if (distancia > 100) { // 50 metros de tolerancia
            alert('No estás en tu sucursal. Debes estar en tu lugar de trabajo para registrar tu entrada.');
            document.body.removeChild(overlay);
            return;
          }
          const ubicacion = `${lat},${lng}`;
          const { error } = await supabase.from('checadas').insert([{
            usuario_id: empleadoId, 
            nombre: empleadoNombre,
            sucursal: empleadoSucursal,
            fecha: fecha,
            hora: hora,
            tipo: 'entrada',
            ubicacion: ubicacion,
            t2: t2Value
          }]);
          if (error) {
            console.error("Error al registrar entrada:", error);
            alert(`Error al registrar entrada: ${error.message}`);
          } else {
            actualizarEstadoCheckInVisual(true, hora, fecha);
            alert('Entrada registrada correctamente.');
          }
          document.body.removeChild(overlay);
        }, async () => { 
          console.warn("No se pudo obtener la ubicación para la entrada.");
          const { error } = await supabase.from('checadas').insert([{
            usuario_id: empleadoId, 
            nombre: empleadoNombre,
            sucursal: empleadoSucursal,
            fecha: fecha,
            hora: hora,
            tipo: 'entrada',
            ubicacion: 'No disponible',
            t2: t2Value
          }]);
          if (error) {
            console.error("Error al registrar entrada (sin ubicación):", error);
            alert(`Error al registrar entrada: ${error.message}`);
          } else {
            actualizarEstadoCheckInVisual(true, hora, fecha);
            alert('Entrada registrada correctamente (ubicación no disponible).');
          }
          document.body.removeChild(overlay);
        });
          }

          let entradaProcesando = false;
          btnTurno.onclick = () => {
        if (entradaProcesando) return;
        entradaProcesando = true;
        btnTurno.disabled = true;
        btnComida.disabled = true;
        registrarEntrada('TURNO');
          };
          btnComida.onclick = () => {
        if (entradaProcesando) return;
        entradaProcesando = true;
        btnTurno.disabled = true;
        btnComida.disabled = true;
        registrarEntrada('COMIDA');
          };
          btnCancelar.onclick = () => document.body.removeChild(overlay);
        });
      }

      if (btnSalida) {
        btnSalida.addEventListener('click', async () => {
          if (!empleadoNombre || !empleadoSucursal) {
        alert('Error: No se ha identificado al empleado o sucursal.');
        return;
          }

          // --- FILTRO: Revisar si ya hay una salida en los últimos 30 minutos ---
          const fechaHoy = getFechaLocal();
          const ahora = new Date();
          const hace30min = new Date(ahora.getTime() - 30 * 60 * 1000);

          // Buscar checadas de salida de este usuario en los últimos 2 días (por si cruza medianoche)
          const { data: checadasRecientes, error: errorChecadas } = await supabase
        .from('checadas')
        .select('fecha, hora, tipo')
        .eq('usuario_id', empleadoId)
        .eq('tipo', 'salida')
        .order('fecha', { ascending: false })
        .order('hora', { ascending: false })
        .limit(10);

          if (!errorChecadas && checadasRecientes && checadasRecientes.length > 0) {
        // Buscar si alguna salida fue en los últimos 30 minutos
        const salidaReciente = checadasRecientes.find(c => {
          const salidaDate = parseChecadaToDate(c.fecha, c.hora);
          return salidaDate && salidaDate > hace30min;
        });
        if (salidaReciente) {
          alert('Ya registraste una salida en los últimos 30 minutos. Espera antes de registrar otra.');
          return;
        }
          }

          // Crear overlay y botones flotantes TURNO y COMIDA
          let overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.background = 'rgba(34,102,187,0.10)';
          overlay.style.zIndex = '99999';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';

          let box = document.createElement('div');
          box.style.background = '#fff';
          box.style.borderRadius = '18px';
          box.style.boxShadow = '0 8px 32px #2d6cdf22, 0 2px 12px #ff980033';
          box.style.padding = '2.2rem 2.5rem 2rem 2.5rem';
          box.style.display = 'flex';
          box.style.flexDirection = 'column';
          box.style.alignItems = 'center';
          box.style.gap = '1.5rem';
          box.style.minWidth = '220px';

          let title = document.createElement('div');
          title.textContent = 'Selecciona tipo de salida';
          title.style.fontWeight = '900';
          title.style.fontSize = '1.18rem';
          title.style.color = '#2266bb';
          title.style.marginBottom = '0.7rem';
          box.appendChild(title);

          let btnTurno = document.createElement('button');
          btnTurno.textContent = 'TURNO';
          btnTurno.style.background = 'linear-gradient(90deg,#1656b7 0%,#2d6cdf 100%)';
          btnTurno.style.color = '#fff';
          btnTurno.style.border = 'none';
          btnTurno.style.borderRadius = '12px';
          btnTurno.style.fontWeight = '800';
          btnTurno.style.fontSize = '1.15rem';
          btnTurno.style.padding = '1.1rem 2.5rem';
          btnTurno.style.cursor = 'pointer';
          btnTurno.style.boxShadow = '0 2px 8px #2d6cdf22';
          btnTurno.style.marginBottom = '0.5rem';

          let btnComida = document.createElement('button');
          btnComida.textContent = 'FIN COMIDA';
          btnComida.style.background = 'linear-gradient(90deg,#ff9800 0%,#fbc02d 100%)';
          btnComida.style.color = '#fff';
          btnComida.style.border = 'none';
          btnComida.style.borderRadius = '12px';
          btnComida.style.fontWeight = '800';
          btnComida.style.fontSize = '1.15rem';
          btnComida.style.padding = '1.1rem 2.5rem';
          btnComida.style.cursor = 'pointer';
          btnComida.style.boxShadow = '0 2px 8px #ff980033';

          let btnCancelar = document.createElement('button');
          btnCancelar.textContent = 'Cancelar';
          btnCancelar.style.background = '#d32f2f';
          btnCancelar.style.color = '#fff';
          btnCancelar.style.border = 'none';
          btnCancelar.style.borderRadius = '10px';
          btnCancelar.style.fontWeight = '700';
          btnCancelar.style.fontSize = '1rem';
          btnCancelar.style.padding = '0.7rem 1.5rem';
          btnCancelar.style.cursor = 'pointer';
          btnCancelar.style.marginTop = '1.2rem';

          box.appendChild(btnTurno);
          box.appendChild(btnComida);
          box.appendChild(btnCancelar);
          overlay.appendChild(box);
          document.body.appendChild(overlay);

          function registrarSalida(t2Value, actualizarSucursalNull) {
        const fecha = getFechaLocal();
        const hora = getHoraLocal(); // HH:MM:SS

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const ubicacionSucursal = SUCURSALES_UBICACION[empleadoSucursal];
          if (!ubicacionSucursal) {
            alert('No hay ubicación registrada para tu sucursal.');
            document.body.removeChild(overlay);
            return;
          }
          const distancia = distanciaMetros(lat, lng, ubicacionSucursal.lat, ubicacionSucursal.lng);
          if (distancia > 100) { // 50 metros de tolerancia
            alert('No estás en tu sucursal. Debes estar en tu lugar de trabajo para registrar tu salida.');
            document.body.removeChild(overlay);
            return;
          }
          const ubicacion = `${lat},${lng}`;
          const { error } = await supabase.from('checadas').insert([{
            usuario_id: empleadoId, 
            nombre: empleadoNombre,
            sucursal: empleadoSucursal,
            fecha: fecha,
            hora: hora,
            tipo: 'salida',
            ubicacion: ubicacion,
            t2: t2Value
          }]);
          if (error) {
            console.error("Error al registrar salida:", error);
            alert(`Error al registrar salida: ${error.message}`);
          } else {
            actualizarEstadoCheckInVisual(false);
            alert('Salida registrada correctamente.');
            if (actualizarSucursalNull){
          const { error: errorUpdateUsuario } = await supabase
            .from('usuarios')
            .update({ sucursal: null })
            .eq('id', empleadoId);
            }
          }
          document.body.removeChild(overlay);
        }, async () => { 
          // Error al obtener ubicación
          const { error } = await supabase.from('checadas').insert([{
            usuario_id: empleadoId,
            nombre: empleadoNombre,
            sucursal: empleadoSucursal,
            fecha: fecha,
            hora: hora,
            tipo: 'salida',
            ubicacion: 'No disponible',
            t2: t2Value
          }]);
          if (error) {
            console.error("Error al registrar salida (sin ubicación):", error);
            alert(`Error al registrar salida: ${error.message}`);
          } else {
            actualizarEstadoCheckInVisual(false);
            alert('Salida registrada correctamente (ubicación no disponible).');
            if (actualizarSucursalNull) {
          const { error: errorUpdateUsuario } = await supabase
            .from('usuarios')
            .update({ sucursal: null })
            .eq('id', empleadoId);
          if (errorUpdateUsuario) {
            console.error("Error al actualizar sucursal del usuario (sin ubicación):", errorUpdateUsuario);
          } else {
            empleadoSucursal = "";
          }
            }
          }
          document.body.removeChild(overlay);
        });
          }
          let salidaProcesando = false;
          btnTurno.onclick = () => {
        if (salidaProcesando) return;
        salidaProcesando = true;
        btnTurno.disabled = true;
        btnComida.disabled = true;
        registrarSalida('TURNO', true);
          };
          btnComida.onclick = () => {
        if (salidaProcesando) return;
        salidaProcesando = true;
        btnTurno.disabled = true;
        btnComida.disabled = true;
        registrarSalida('COMIDA', false);
          };
          btnCancelar.onclick = () => document.body.removeChild(overlay);
        });
      }

      // --- NUEVO: Función para mostrar notificación de avisos no leídos ---
    async function mostrarNotificacionAvisos() {
      // Buscar avisos para la sucursal del empleado o para TODAS
      let sucursal = empleadoSucursal || "";
      // Si no tienes sucursal en usuarios, puedes pedirla aquí o mostrar todos los avisos
      const { data: avisos, error } = await supabase
        .from('avisos')
        .select('id,sucursal,texto')
        .or(`sucursal.eq.${sucursal},sucursal.eq.TODAS`)
        .order('id', { ascending: false });

      if (error || !avisos || avisos.length === 0) return;

      // Buscar avisos leídos por este usuario
      const { data: leidos, error: errorLeidos } = await supabase
        .from('avisos_leidos')
        .select('aviso_id')
        .eq('usuario', empleadoNombre);

      const leidosIds = (leidos || []).map(a => a.aviso_id);
      // Filtrar avisos no leídos
      const noLeidos = avisos.filter(a => !leidosIds.includes(a.id));
      if (noLeidos.length > 0) {
        // Mostrar notificación visual con mejor aspecto e icono
        let notif = document.createElement('div');
        notif.id = "aviso-notif";
        notif.style.position = "fixed";
        notif.style.top = "22px";
        notif.style.right = "22px";
        notif.style.zIndex = "99999";
        notif.style.background = "#ff9800"; // Color sólido
        notif.style.color = "#fff";
        notif.style.padding = "1.2rem 2.1rem 1.2rem 1.1rem";
        notif.style.borderRadius = "18px";
        notif.style.boxShadow = "0 6px 24px #ff980055, 0 1.5px 8px #ff980022";
        notif.style.fontWeight = "900";
        notif.style.fontSize = "1.13rem";
        notif.style.letterSpacing = "1.1px";
        notif.style.cursor = "pointer";
        notif.style.display = "flex";
        notif.style.alignItems = "center";
        notif.style.gap = "1.1rem";
        notif.style.border = "2.5px solid #ff9800";
        notif.innerHTML = `
          <span style="display:flex;align-items:center;justify-content:center;background:#fff3e0;border-radius:50%;width:38px;height:38px;box-shadow:0 2px 8px #ff980022;margin-right:0.5rem;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
              <path d="M12 9v4" stroke="#ff9800" stroke-width="2" stroke-linecap="round"/>
              <circle cx="12" cy="17" r="1.3" fill="#ff9800"/>
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="#ff9800" stroke-width="2"/>
            </svg>
          </span>
          <span>
            Tienes <b>${noLeidos.length}</b> aviso(s) sin leer.<br>
            <span style="text-decoration:underline;font-weight:700;">Ver avisos</span>
          </span>
        `;
        notif.onclick = function() {
          // Simula click en botón de avisos
          document.querySelectorAll('#empleadoPanel .sidebar-btn')[2].click();
          notif.remove();
        };
        document.body.appendChild(notif);
        setTimeout(() => { if (notif) notif.remove(); }, 12000);
      }
    }

    // --- MODIFICAR BOTÓN AVISOS EN PANEL EMPLEADO ---
    document.querySelectorAll('#empleadoPanel .sidebar-btn').forEach(function(btn, idx) {
      btn.addEventListener('click', async function () {
        // Si es el botón de Avisos (índice 2)
        if (idx === 2) {
          document.getElementById('adminContentBox').style.display = 'flex';
          const area = document.getElementById('adminContentArea');
          area.innerHTML = `<div style="text-align:center;color:#2266bb;font-weight:700;font-size:1.1rem;margin-bottom:1rem;">Cargando avisos...</div>`;
          // Buscar avisos para la sucursal del empleado o para TODAS
          let sucursal = empleadoSucursal || "";
          const { data: avisos, error } = await supabase
            .from('avisos')
            .select('id,sucursal,texto,created_at')
            .or(`sucursal.eq.${sucursal},sucursal.eq.TODAS`)
            .order('id', { ascending: false });

          if (error || !avisos || avisos.length === 0) {
            area.innerHTML = `<div style="color:#888;text-align:center;">No hay avisos para tu sucursal.</div>`;
            return;
          }
          // Buscar avisos leídos por este usuario
          const { data: leidos, error: errorLeidos } = await supabase
            .from('avisos_leidos')
            .select('aviso_id')
            .eq('usuario', empleadoNombre);

          const leidosIds = (leidos || []).map(a => a.aviso_id);

          // Renderizar avisos
          area.innerHTML = `
            <div style="width:100%;max-width:520px;margin:0 auto;">
              <h2 style="color:#2266bb;font-size:1.25rem;font-weight:900;text-align:center;margin-bottom:1.2rem;">Avisos</h2>
              <div style="display:flex;flex-direction:column;gap:1.1rem;">
                ${avisos.map(aviso => `
                  <div style="background:${leidosIds.includes(aviso.id) ? '#fafdff' : '#fffbe6'};border:2px solid #b3c6e0;border-radius:12px;padding:1rem 1.1rem;box-shadow:0 2px 8px #2d6cdf11;">
                    <div style="font-weight:700;color:#2266bb;font-size:1.08rem;margin-bottom:0.3rem;">
                      ${aviso.sucursal === "TODAS" ? "Todas las sucursales" : "Sucursal: " + aviso.sucursal}
                      <span style="float:right;font-size:0.98rem;color:#888;font-weight:400;">${new Date(aviso.created_at).toLocaleString('es-MX')}</span>
                    </div>
                    <div style="font-size:1.08rem;color:#1656b7;margin-bottom:0.4rem;white-space:pre-line;">${aviso.texto}</div>
                    ${leidosIds.includes(aviso.id) ? `<span style="color:#388e3c;font-weight:700;font-size:0.98rem;">Leído</span>` : `<button class="marcar-leido-btn" data-id="${aviso.id}" style="background:#2d6cdf;color:#fff;border:none;border-radius:7px;padding:0.4rem 1.1rem;font-weight:700;cursor:pointer;font-size:1rem;">Marcar como leído</button>`}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          // Botones marcar como leído
          area.querySelectorAll('.marcar-leido-btn').forEach(function(btn) {
            btn.onclick = async function() {
              const avisoId = btn.getAttribute('data-id');
              btn.disabled = true;
              btn.textContent = '...';
              await supabase
                .from('avisos_leidos')
                .insert([{ aviso_id: avisoId, usuario: empleadoNombre }]);
              // Refrescar la lista de avisos
              document.querySelectorAll('#empleadoPanel .sidebar-btn')[2].click();
            };
          });
          // Eliminar notificación si existe
          const notif = document.getElementById('aviso-notif');
          if (notif) notif.remove();
        }
      });
    });

    // ...existing code...
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
