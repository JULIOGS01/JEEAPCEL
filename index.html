<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checador Jeeapcel - Panel Admin</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #eef3f8;
      padding: 40px;
      text-align: center;
    }

    h2 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #222;
    }

    form, .panel {
      background: white;
      display: inline-block;
      padding: 20px;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: left;
    }

    input, select {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }

    button {
      padding: 10px 20px;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }

    button:hover {
      background: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    #mensaje {
      margin-top: 20px;
      font-size: 1.1em;
    }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://mubtfuksnxtbjxrrwzqh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11YnRmdWtzbnh0Ymp4cnJ3enFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Njc0OTcsImV4cCI6MjA2NDI0MzQ5N30.B7ZyBG2g4hCfdI2A2aX852icnHb_JPpfc0VyO0Zr4PA'
    );

    window.addEventListener('DOMContentLoaded', async () => {
      const mensaje = document.getElementById('mensaje');

      // 1. Crear usuario
      document.getElementById('formCrear').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('nuevoNombre').value.trim();
        const nip = document.getElementById('nuevoNip').value.trim();
        const rol = document.getElementById('nuevoRol').value;

        const { error } = await supabase.from('usuarios').insert([{ nombre, nip, rol, activo: true }]);

        if (error) {
          mensaje.textContent = '‚ùå Error al crear usuario';
        } else {
          mensaje.textContent = `‚úÖ Usuario ${nombre} creado correctamente`;
          document.getElementById('formCrear').reset();
          cargarUsuarios();
        }
      });

      // 2. Mostrar usuarios y permitir desactivar
      async function cargarUsuarios() {
        const { data, error } = await supabase.from('usuarios').select('*').eq('activo', true);
        const tabla = document.getElementById('tablaUsuarios');
        tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>√öltima entrada</th><th>Desactivar</th></tr>';

        data.forEach(user => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${user.nombre}</td>
            <td>${user.rol}</td>
            <td>${user.ultima_entrada ? new Date(user.ultima_entrada).toLocaleString() : '-'}</td>
            <td><button onclick="desactivarUsuario(${user.id})">‚ùå</button></td>
          `;
          tabla.appendChild(fila);
        });
      }

      window.desactivarUsuario = async (id) => {
        await supabase.from('usuarios').update({ activo: false }).eq('id', id);
        mensaje.textContent = '‚ö†Ô∏è Usuario desactivado';
        cargarUsuarios();
      };

      // 3. Buscar por fecha
      document.getElementById('formFecha').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fecha = document.getElementById('fechaBuscada').value;
        const { data, error } = await supabase
          .from('usuarios')
          .select('*')
          .gte('ultima_entrada', fecha + 'T00:00:00')
          .lte('ultima_entrada', fecha + 'T23:59:59');

        const tabla = document.getElementById('tablaChecadas');
        tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>Hora de entrada</th></tr>';
        data.forEach(user => {
          const fila = document.createElement('tr');
          fila.innerHTML = `<td>${user.nombre}</td><td>${user.rol}</td><td>${new Date(user.ultima_entrada).toLocaleTimeString()}</td>`;
          tabla.appendChild(fila);
        });
      });

      // Al cargar
      cargarUsuarios();
    });
  </script>
</head>
<body>
  <h2>üëë Panel de Administraci√≥n Jeeapcel</h2>

  <div class="panel">
    <h3>‚ûï Crear Usuario</h3>
    <form id="formCrear">
      <input type="text" id="nuevoNombre" placeholder="Nombre" required><br>
      <input type="password" id="nuevoNip" placeholder="NIP" required><br>
      <select id="nuevoRol" required>
        <option value="">Selecciona un rol</option>
        <option value="admin">admin</option>
        <option value="supervisor">supervisor</option>
        <option value="empleado">empleado</option>
      </select><br>
      <button type="submit">Crear</button>
    </form>
  </div>

  <div class="panel">
    <h3>üëÅÔ∏è Usuarios activos</h3>
    <table id="tablaUsuarios"></table>
  </div>

  <div class="panel">
    <h3>üìÖ Ver checadas por fecha</h3>
    <form id="formFecha">
      <input type="date" id="fechaBuscada" required>
      <button type="submit">Buscar</button>
    </form>
    <table id="tablaChecadas"></table>
  </div>

  <div id="mensaje"></div>
</body>
</html>
