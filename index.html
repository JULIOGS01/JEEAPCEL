<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checador Jeeapcel - Panel</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #eef3f8;
            padding: 40px;
            text-align: center;
        }

        h2, h3, h4 {
            color: #222;
        }

        form, .panel, .seccion {
            background: white;
            display: inline-block;
            padding: 20px;
            margin-top: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: left;
            max-width: 500px;
        }

        input, select, textarea {
            padding: 8px;
            margin-top: 5px;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1em;
        }

        button {
            padding: 10px 20px;
            background: #0077cc; /* Color original */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }

        button:hover {
            background: #005fa3; /* Color original */
        }

        .btn-checkin {
            background: #28a745; /* Verde */
        }

        .btn-checkout {
            background: #dc3545; /* Rojo */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table, th, td {
            border: 1px solid #ccc;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        #mensaje {
            margin-top: 20px;
            font-size: 1.1em;
        }

        .seccion {
            display: none;
        }
    </style>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@latest/+esm';

        const supabase = createClient(
            'https://mubtfuksnxtbjxrrwzqh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11YnRmdWtzbnh0Ymp4cnJ3enFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Njc0OTcsImV4cCI6MjA2NDI0MzQ5N30.B7ZyBG2g4hCfdI2A2aX852icnHb_JPpfc0VyO0Zr4PA'
        );

        window.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            const loginTitle = document.getElementById('loginTitle');
            const adminPanel = document.getElementById('adminPanel');
            const empleadoPanel = document.getElementById('empleadoPanel');
            const mensaje = document.getElementById('mensaje');
            const cerrarSesionAdmin = document.getElementById('cerrarSesionAdmin');
            const cerrarSesionEmpleado = document.getElementById('cerrarSesionEmpleado');
            const bienvenida = document.getElementById('bienvenida');

            const secciones = {
                crear: document.getElementById('seccionCrear'),
                verUsuarios: document.getElementById('seccionUsuarios'),
                checadas: document.getElementById('seccionChecadas'),
                aviso: document.getElementById('seccionAviso'),
                reporte: document.getElementById('seccionReporte'),
                avisosEmpleado: document.getElementById('seccionAvisosEmpleado'),
                checadasEmpleado: document.getElementById('seccionChecadasEmpleado')
            };

            adminPanel.style.display = 'none';
            empleadoPanel.style.display = 'none';
            cerrarSesionAdmin.style.display = 'none';
            cerrarSesionEmpleado.style.display = 'none';

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = document.getElementById('nombre').value.trim();
                const nip = document.getElementById('nip').value.trim();

                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('nombre', nombre)
                    .eq('nip', nip)
                    .eq('activo', true)
                    .single();

                if (error || !data) {
                    mensaje.textContent = '‚ùå Usuario o NIP incorrecto';
                } else {
                    mensaje.textContent = `‚úÖ Bienvenido, ${data.nombre} | Rol: ${data.rol}`;
                    loginForm.style.display = 'none';
                    loginTitle.textContent = '';
                    cerrarSesionAdmin.style.display = 'inline-block';
                    cerrarSesionEmpleado.style.display = 'inline-block';
                    bienvenida.textContent = `Bienvenido, ${data.nombre}`;

                    if (data.rol === 'admin') {
                        adminPanel.style.display = 'block';
                    } else if (data.rol === 'empleado') {
                        const sucursal = prompt("Selecciona tu sucursal (A, B, C, D, E, F):");
                        if (['A', 'B', 'C', 'D', 'E', 'F'].includes(sucursal)) {
                            empleadoPanel.style.display = 'block';
                            document.getElementById('sucursalEmpleado').textContent = `Sucursal: ${sucursal}`;
                            cargarAvisos();
                        } else {
                            mensaje.textContent = '‚ùå Sucursal no v√°lida';
                        }
                    }
                }
            });

            cerrarSesionAdmin.addEventListener('click', () => {
                location.reload();
            });

            cerrarSesionEmpleado.addEventListener('click', () => {
                location.reload();
            });

            document.getElementById('formCrear').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = document.getElementById('nuevoNombre').value.trim();
                const nip = document.getElementById('nuevoNip').value.trim();
                const rol = document.getElementById('nuevoRol').value;

                const { error } = await supabase.from('usuarios').insert([{ nombre, nip, rol, activo: true }]);

                if (error) {
                    mensaje.textContent = '‚ùå Error al crear usuario';
                } else {
                    mensaje.textContent = `‚úÖ Usuario ${nombre} creado correctamente`;
                    document.getElementById('formCrear').reset();
                    cargarUsuarios();
                }
            });

            async function cargarUsuarios() {
                const { data } = await supabase.from('usuarios').select('*').eq('activo', true);
                const tabla = document.getElementById('tablaUsuarios');
                tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>√öltima entrada</th><th>Desactivar</th></tr>';
                data.forEach(user => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>${user.nombre}</td>
                        <td>${user.rol}</td>
                        <td>${user.ultima_entrada ? new Date(user.ultima_entrada).toLocaleString() : '-'}</td>
                        <td><button onclick="desactivarUsuario(${user.id})">‚ùå</button></td>
                    `;
                    tabla.appendChild(fila);
                });
            }

            window.desactivarUsuario = async (id) => {
                await supabase.from('usuarios').update({ activo: false }).eq('id', id);
                mensaje.textContent = '‚ö†Ô∏è Usuario desactivado';
                cargarUsuarios();
            };

            document.getElementById('formFecha').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fecha = document.getElementById('fechaBuscada').value;
                const sucursal = document.getElementById('sucursalFiltro').value;
                const { data } = await supabase
                    .from('checadas')
                    .select('*')
                    .gte('fecha', fecha + 'T00:00:00')
                    .lte('fecha', fecha + 'T23:59:59')
                    .eq('sucursal', sucursal);

                const tabla = document.getElementById('tablaChecadas');
                tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>Hora de entrada</th><th>Hora de salida</th></tr>';
                data.forEach(user => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `<td>${user.nombre}</td><td>${user.rol}</td><td>${new Date(user.hora_entrada).toLocaleTimeString()}</td><td>${user.hora_salida ? new Date(user.hora_salida).toLocaleTimeString() : '-'}</td>`;
                    tabla.appendChild(fila);
                });
            });

            document.getElementById('formAviso').addEventListener('submit', (e) => {
                e.preventDefault();
                const texto = document.getElementById('avisoTexto').value;
                const rol = document.getElementById('rolDestino').value;
                const sucursal = document.getElementById('sucursales').value;
                console.log('Aviso creado para', rol, 'en', sucursal, ':', texto);
                mensaje.textContent = `üì£ Aviso enviado a ${rol} en ${sucursal}`;
                e.target.reset();
            });

            document.getElementById('formReporte').addEventListener('submit', (e) => {
                e.preventDefault();
                const link = document.getElementById('nuevoLink').value;
                localStorage.setItem('linkReporte', link);
                mensaje.textContent = 'üîó Link actualizado correctamente';
            });

            async function cargarAvisos() {
                const { data } = await supabase.from('avisos').select('*');
                const tabla = document.getElementById('tablaAvisosEmpleado');
                tabla.innerHTML = '<tr><th>Aviso</th><th>Rol</th><th>Sucursal</th></tr>';
                data.forEach(aviso => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `<td>${aviso.texto}</td><td>${aviso.rol}</td><td>${aviso.sucursal}</td>`;
                    tabla.appendChild(fila);
                });
            }

            document.getElementById('btnCheckIn').addEventListener('click', async () => {
                const nombre = document.getElementById('nombre').value.trim();
                const sucursal = document.getElementById('sucursalEmpleado').textContent.split(': ')[1];
                const { error } = await supabase.from('checadas').insert([{ nombre, sucursal, hora_entrada: new Date() }]);
                if (error) {
                    mensaje.textContent = '‚ùå Error al registrar Check In';
                } else {
                    mensaje.textContent = '‚úÖ Check In registrado correctamente';
                }
            });

            document.getElementById('btnCheckOut').addEventListener('click', async () => {
                const nombre = document.getElementById('nombre').value.trim();
                const sucursal = document.getElementById('sucursalEmpleado').textContent.split(': ')[1];
                const { error } = await supabase.from('checadas').update({ hora_salida: new Date() }).eq('nombre', nombre).eq('sucursal', sucursal).is('hora_salida', null);
                if (error) {
                    mensaje.textContent = '‚ùå Error al registrar Check Out';
                } else {
                    mensaje.textContent = '‚úÖ Check Out registrado correctamente';
                }
            });

            window.mostrarSeccion = (id) => {
                for (const key in secciones) {
                    secciones[key].style.display = 'none';
                }
                secciones[id].style.display = 'block';
                if (id === 'verUsuarios') cargarUsuarios();
            };
        });
    </script>
</head>
<body>
    <h2 id="loginTitle">üîê Iniciar sesi√≥n en Jeeapcel</h2>
    <h3 id="bienvenida"></h3>
    <form id="loginForm">
        <input type="text" id="nombre" placeholder="Nombre" required><br>
        <input type="password" id="nip" placeholder="NIP" required><br>
        <button type="submit">Entrar</button>
    </form>

    <div class="panel" id="adminPanel">
        <h3>üõ†Ô∏è Panel de administrador</h3>
        <button onclick="mostrarSeccion('crear')">‚ûï Crear Usuario</button>
        <button onclick="mostrarSeccion('verUsuarios')">üëÅÔ∏è Ver Usuarios Activos</button>
        <button onclick="mostrarSeccion('checadas')">üìÖ Ver Checadas por Fecha</button>
        <button onclick="mostrarSeccion('aviso')">üì£ Crear Aviso</button>
        <button onclick="mostrarSeccion('reporte')">üîó Actualizar Link Reportes</button>
        <button id="cerrarSesionAdmin">üîì Cerrar sesi√≥n</button>

        <div id="seccionCrear" class="seccion">
            <h4>‚ûï Crear Usuario</h4>
            <form id="formCrear">
                <input type="text" id="nuevoNombre" placeholder="Nombre" required><br>
                <input type="password" id="nuevoNip" placeholder="NIP" required><br>
                <select id="nuevoRol" required>
                    <option value="">Selecciona un rol</option>
                    <option value="admin">admin</option>
                    <option value="supervisor">supervisor</option>
                    <option value="empleado">empleado</option>
                </select><br>
                <button type="submit">Crear</button>
            </form>
        </div>

        <div id="seccionUsuarios" class="seccion">
            <h4>üëÅÔ∏è Usuarios activos</h4>
            <table id="tablaUsuarios"></table>
        </div>

        <div id="seccionChecadas" class="seccion">
            <h4>üìÖ Checadas por fecha</h4>
            <form id="formFecha">
                <input type="date" id="fechaBuscada" required>
                <select id="sucursalFiltro" required>
                    <option value="A">Sucursal A</option>
                    <option value="B">Sucursal B</option>
                    <option value="C">Sucursal C</option>
                    <option value="D">Sucursal D</option>
                    <option value="E">Sucursal E</option>
                    <option value="F">Sucursal F</option>
                </select>
                <button type="submit">Buscar</button>
            </form>
            <table id="tablaChecadas"></table>
        </div>

        <div id="seccionAviso" class="seccion">
            <h4>üì£ Crear Aviso</h4>
            <form id="formAviso">
                <textarea id="avisoTexto" placeholder="Escribe el aviso..." required></textarea><br>
                <select id="rolDestino">
                    <option value="todos">Todos los roles</option>
                    <option value="admin">Solo admins</option>
                    <option value="supervisor">Supervisores</option>
                    <option value="empleado">Empleados</option>
                </select>
                <select id="sucursales">
                    <option value="todas">Todas las sucursales</option>
                    <option value="A">Sucursal A</option>
                    <option value="B">Sucursal B</option>
                    <option value="C">Sucursal C</option>
                    <option value="D">Sucursal D</option>
                    <option value="E">Sucursal E</option>
                    <option value="F">Sucursal F</option>
                </select>
                <button type="submit">Enviar aviso</button>
            </form>
        </div>

        <div id="seccionReporte" class="seccion">
            <h4>üîó Actualizar link de reportes</h4>
            <form id="formReporte">
                <input type="url" id="nuevoLink" placeholder="Pega aqu√≠ el nuevo link del reporte" required>
                <button type="submit">Actualizar</button>
            </form>
        </div>
    </div>

    <div class="panel" id="empleadoPanel">
        <h3>üë®‚Äçüíº Panel de Empleado</h3>
        <h4 id="sucursalEmpleado"></h4>
        <button id="btnCheckIn" class="btn-checkin">‚úÖ Check In</button>
        <button id="btnCheckOut" class="btn-checkout">‚ùå Check Out</button>
        <button onclick="mostrarSeccion('avisosEmpleado')">üì£ Ver Avisos</button>
        <button onclick="window.open(localStorage.getItem('linkReporte'), '_blank')">üîó Link Reportes</button>
        <button id="cerrarSesionEmpleado">üîì Cerrar sesi√≥n</button>

        <div id="seccionAvisosEmpleado" class="seccion">
            <h4>üì£ Avisos</h4>
            <table id="tablaAvisosEmpleado"></table>
        </div>
    </div>

    <div id="mensaje"></div>
</body>
</html>
