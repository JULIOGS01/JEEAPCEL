<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checador Jeeapcel - Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* ====== RESET Y BASE ====== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* <-- Agrega esta línea */
            min-height: 100vh;       /* <-- Agrega esta línea */
            margin-left: 35px;
            width: 100%;
        }
        h2, h3, h4 {
            color: #1a2233;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        /* ====== SLIDEBAR ====== */
        .slidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 220px;
            height: 100vh;
            background: linear-gradient(180deg, #4f8cff 0%, #2563eb 100%);
            box-shadow: 2px 0 16px rgba(31,38,135,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
            padding-top: 32px;
            transition: width 0.2s;
        }
        .slidebar .logo {
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slidebar .logo i {
            font-size: 2em;
            color: #fff;
        }
        .slidebar .logo span {
            color: #fff;
            font-weight: bold;
            font-size: 1.2em;
            letter-spacing: 1px;
        }
        .slidebar .sidebar-btns {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .slidebar .sidebar-btns button {
            width: 90%;
            margin: 0 auto;
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, transform 0.12s;
            box-shadow: 0 2px 8px rgba(31,38,135,0.08);
        }
        .slidebar .sidebar-btns button i {
            color: #fff !important;
            font-size: 1.2em;
            transition: color 0.18s;
        }
        .slidebar .sidebar-btns button:hover,
        .slidebar .sidebar-btns button:focus {
            background: #2563eb;
            color: #fff;
            transform: scale(1.06);
        }
        .slidebar .sidebar-btns button:hover i,
        .slidebar .sidebar-btns button:focus i {
            color: #fff !important;
        }
        .slidebar .sidebar-btns button:active {
            transform: scale(0.97);
        }
        .slidebar .sidebar-footer {
            margin-top: auto;
            margin-bottom: 32px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .slidebar .sidebar-footer button {
            width: 90%;
            background: #ff4d4f;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            padding: 12px 18px;
            margin-top: 8px;
            transition: background 0.18s;
        }
        .slidebar .sidebar-footer button:hover {
            background: #d9363e;
        }
        /* ====== PANEL GENERAL ====== */
        .panel {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.10);
            padding: 32px 36px 24px 36px;
            margin: 32px auto 0 auto;
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .seccion {
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            padding: 24px 20px 16px 20px;
            margin: 18px 0;
            width: 100%;
            display: none;
            align-items: center;
        }
        /* ====== FORMULARIOS ====== */
        form {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }
        input, select, textarea {
            padding: 10px 14px;
            margin-top: 5px;
            width: 90%;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1.5px solid #bfc9d9;
            font-size: 1em;
            background: #f7faff;
            transition: border 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border: 1.5px solid #4f8cff;
            outline: none;
            background: #f0f4ff;
        }
        button {
            padding: 12px 28px;
            background: #4f8cff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            margin: 6px 4px;
            box-shadow: 0 2px 8px rgba(79,140,255,0.08);
            transition: background 0.2s, transform 0.1s;
        }
        button:hover {
            background: #3b6ed6;
            transform: translateY(-2px) scale(1.04);
        }
        /* ====== TABLAS ====== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 14px;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        th {
            background: #4f8cff;
            color: #fff;
            padding: 12px 0;
            font-size: 1.05em;
            letter-spacing: 0.5px;
        }
        td {
            padding: 10px 0;
            color: #222;
            font-size: 1em;
            background: #f9fbff;
        }
        tr:nth-child(even) td {
            background: #eef3fa;
        }
        /* ====== MENSAJES Y ESTADOS ====== */
        #mensaje {
            margin-top: 24px;
            font-size: 1.15em;
            font-weight: bold;
            color: #2563eb;
            text-align: center;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #mensaje i {
            font-size: 1.2em;
        }
        #ultimoCheckIn {
            margin-bottom: 18px;
            color: #28a745;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        /* ====== ICONOS ====== */
        i.fas, i.far, i.fa-solid {
            color: #4f8cff;
            margin-right: 8px;
        }
        button i.fas {
            color: #fff !important;
        }
        /* ====== LOGIN ====== */
        #loginForm {
            width: 100%;
            max-width: 320px;
            margin: 32px auto 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(31,38,135,0.07);
            padding: 28px 18px 18px 18px;
        }
        #loginForm input {
            width: 85%;
            margin-bottom: 14px;
            font-size: 1em;
            border-radius: 6px;
            border: 1.2px solid #bfc9d9;
            background: #f7faff;
            transition: border 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 4px rgba(79,140,255,0.04);
        }
        #loginForm input:focus {
            border: 1.5px solid #4f8cff;
            background: #f0f4ff;
            box-shadow: 0 2px 8px rgba(79,140,255,0.10);
        }
        #loginForm button {
            width: 85%;
            margin-top: 8px;
            border-radius: 6px;
            font-size: 1.08em;
            background: #4f8cff;
            transition: background 0.2s, transform 0.1s;
        }
        #loginForm button:hover {
            background: #3b6ed6;
            transform: translateY(-2px) scale(1.04);
        }
        /* ====== PANEL EMPLEADO ====== */
        #empleadoPanel .main-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 18px;
            margin-top: 8px;
        }
        #empleadoPanel .main-btns button {
            min-width: 140px;
            max-width: 200px;
            background: #f7faff;
            color: #234;
            border: 1.2px solid #bfc9d9;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: background 0.2s, color 0.2s, border 0.2s;
        }
        #empleadoPanel .main-btns button i {
            color: #4f8cff !important;
            margin-right: 6px;
            font-size: 1.1em;
            transition: color 0.2s;
        }
        #empleadoPanel .main-btns button:hover {
            background: #e6f0ff;
            color: #2563eb;
            border: 1.2px solid #4f8cff;
        }
        #empleadoPanel .main-btns button:hover i {
            color: #2563eb !important;
        }
        #empleadoPanel .check-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 18px 0 0 0;
        }
        #empleadoPanel .logout-btn {
            display: flex;
            justify-content: center;
            margin: 18px 0 0 0;
        }
        #empleadoPanel #cerrarSesionEmpleado {
            width: 180px;
            background: #ff4d4f;
            color: #fff;
            border: none;
            font-weight: bold;
            font-size: 1.08em;
            border-radius: 8px;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(255,77,79,0.08);
            transition: background 0.2s, transform 0.1s;
        }
        #empleadoPanel #cerrarSesionEmpleado:hover {
            background: #d9363e;
            transform: translateY(-2px) scale(1.04);
        }
        /* ====== TABULADOR EMPLEADO ====== */
        #seccionTabuladorEmpleado {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            padding-bottom: 10px;
            max-width: 340px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        #seccionTabuladorEmpleado form {
            max-width: 300px;
            width: 100%;
            margin: 0 auto;
            padding: 0;
            gap: 4px;
        }
        #seccionTabuladorEmpleado input,
        #seccionTabuladorEmpleado select {
            width: 100%;
            max-width: 220px;
            min-width: 100px;
            margin: 0 auto 4px auto;
            padding: 5px 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        #seccionTabuladorEmpleado label {
            width: 100%;
            max-width: 220px;
            margin: 0 auto 1px auto;
            display: block;
            text-align: left;
            font-size: 13px;
        }
        #seccionTabuladorEmpleado button,
        #seccionTabuladorEmpleado .print-btn {
            width: 220px;
            max-width: 220px;
            min-width: 120px;
            margin: 10px auto 0 auto;
            display: block;
            font-size: 15px;
            white-space: nowrap;
        }
        #seccionTabuladorEmpleado .ticket {
            margin-left: auto;
            margin-right: auto;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px 5px;
        }
        #seccionTabuladorEmpleado .ticket h2,
        #seccionTabuladorEmpleado .ticket h3 {
            font-size: 17px;
            margin-bottom: 6px;
        }
        #seccionTabuladorEmpleado .ticket p {
            margin-bottom: 6px;
            font-size: 14px;
        }
        #seccionTabuladorEmpleado .ticket img {
            max-width: 120px;
        }
        #seccionTabuladorEmpleado .total-center {
            font-size: 22px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        @media (max-width: 500px) {
            #seccionTabuladorEmpleado form,
            #seccionTabuladorEmpleado input,
            #seccionTabuladorEmpleado select,
            #seccionTabuladorEmpleado label,
            #seccionTabuladorEmpleado button {
                max-width: 98vw;
                font-size: 13px;
            }
        }
        /* ====== SECCIONES ESPECIALES ====== */
        #seccionAmigoPaguitos,
        #seccionTarifario {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            margin: 18px 0;
            width: 100%;
            max-width: 600px;
            margin-left: -20px;
            margin-right: 0;
        }
        #seccionAmigoPaguitos h4,
        #seccionTarifario h4 {
            margin-bottom: 16px;
            font-size: 1.2em;
            color: #1a2233;
        }
        #seccionAmigoPaguitos iframe,
        #seccionTarifario iframe {
            width: 100%;
            max-width: 600px;
            border: none;
            border-radius: 8px;
            height: 800px;
            display: block;
        }
        @media (max-width: 700px) {
            #seccionAmigoPaguitos,
            #seccionTarifario {
                margin-left: 0 !important;
                margin-right: 0 !important;
                max-width: 98vw;
                padding: 12px 2vw;
            }
        }
        /* ====== AVISOS EMPLEADO ====== */
        #seccionAvisosEmpleado {
            margin-left: -20px;
        }
        @media (max-width: 700px) {
            #seccionAvisosEmpleado {
                margin-left: 0 !important;
            }
        }
        @media (max-width: 900px) {
            .slidebar {
                display: none !important;
            }
            #main-content {
                margin-left: 0 !important;
            }
            .sidebar-toggle-btn {
                display: flex !important;
            }
        }
        .sidebar-toggle-btn {
            position: fixed;
            top: 18px;
            left: 18px;
            z-index: 200;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(31,38,135,0.18);
            cursor: pointer;
            font-size: 1.7em;
            transition: background 0.18s, transform 0.12s;
        }
        .sidebar-toggle-btn i.fas.fa-bars {
            margin: 0 !important;
            position: relative;
            top: 1px; /* Ajusta este valor si lo quieres aún más centrado */
            left: 0;
            font-size: 1.3em;
            display: block;
        }
        .sidebar-toggle-btn:active {
            transform: scale(0.93);
        }
        .slidebar.sidebar-mobile {
            display: flex !important;
            position: fixed;
            left: 0;
            top: 0;
            width: 220px;
            height: 100vh;
            z-index: 300;
            background: linear-gradient(180deg, #4f8cff 0%, #2563eb 100%);
            animation: sidebarIn 0.18s;
        }
        @keyframes sidebarIn {
            from { transform: translateX(-240px); opacity: 0.5; }
            to { transform: translateX(0); opacity: 1; }
        }
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.18);
            z-index: 250;
        }
        .sidebar-overlay.active {
            display: block;
        }
        html, body {
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        #main-content, .panel, .seccion {
            max-width: 100vw;
            box-sizing: border-box;
        }
    </style>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@latest/+esm';

        // --- Configuración Supabase ---
        const supabase = createClient(
            'https://mubtfuksnxtbjxrrwzqh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11YnRmdWtzbnh0Ymp4cnJ3enFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Njc0OTcsImV4cCI6MjA2NDI0MzQ5N30.B7ZyBG2g4hCfdI2A2aX852icnHb_JPpfc0VyO0Zr4PA'
        );

        // --- Variables globales ---
        let usuarioActual = null;
        let sucursalActual = null;
        const linkReporteGlobal = 'https://forms.gle/63Q3eGbGEckwrTBz7';
        const linkInventarioGlobal = 'https://forms.gle/JWbeMAeBABXnkxXy9';

        // --- Utilidades generales ---
        function formatNumber(number) {
            return new Intl.NumberFormat('es-MX').format(number);
        }
        function formatDate(fecha) {
            const [year, month, day] = fecha.split('-');
            return `${day}/${month}/${year}`;
        }
        function getFechaLocal() {
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // --- Funciones de autenticación y paneles ---
        function mostrarPanel(rol) {
            document.getElementById('adminPanel').style.display = rol === 'admin' ? 'block' : 'none';
            document.getElementById('empleadoPanel').style.display = rol === 'empleado' ? 'block' : 'none';
            document.getElementById('sidebarAdmin').style.display = rol === 'admin' ? 'flex' : 'none';
            document.getElementById('sidebarEmpleado').style.display = rol === 'empleado' ? 'flex' : 'none';
            // Oculta los botones de cerrar sesión antiguos
            
        }

        function ocultarPaneles() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('empleadoPanel').style.display = 'none';
            document.getElementById('sidebarAdmin').style.display = 'none';
            document.getElementById('sidebarEmpleado').style.display = 'none';
        }

        // --- Funciones de usuario y avisos ---
        async function cargarUsuarios() {
            const { data } = await supabase.from('usuarios').select('*').eq('activo', true);
            const tabla = document.getElementById('tablaUsuarios');
            tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>Última entrada</th><th>Desactivar</th></tr>';
            data.forEach  (user => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${user.nombre}</td>
                    <td>${user.rol}</td>
                    <td>${user.ultima_entrada ? new Date(user.ultima_entrada).toLocaleString() : '-'}</td>
                    <td><button onclick="desactivarUsuario('${user.id}')">❌</button></td>
                `;
                tabla.appendChild(fila);
            });
        }
        window.desactivarUsuario = async (id) => {
            await supabase.from('usuarios').update({ activo: false }).eq('id', id);
            document.getElementById('mensaje').textContent = '⚠️ Usuario desactivado';
            cargarUsuarios();
        };

        async function cargarAvisos() {
            const { data } = await supabase.from('avisos').select('*');
            const tabla = document.getElementById('tablaAvisosEmpleado');
            tabla.innerHTML = '<tr><th>Aviso</th><th>Sucursal</th></tr>';
            data.forEach(aviso => {
                const fila = document.createElement('tr');
                fila.innerHTML = `<td>${aviso.texto}</td><td>${aviso.sucursal}</td>`;
                tabla.appendChild(fila);
            });
        }

        // --- Funciones de checadas ---
        async function cargarChecadas(fechaInicio, fechaFin) {
            const { data, error } = await supabase
                .from('checadas')
                .select('*')
                .gte('fecha', fechaInicio)
                .lte('fecha', fechaFin)
                .order('fecha', { ascending: true })
                .order('hora', { ascending: true });
            const tabla = document.getElementById('tablaChecadas');
            tabla.innerHTML = '<tr><th>Nombre</th><th>Sucursal</th><th>Fecha</th><th>Hora</th><th>Tipo</th></tr>';
            if (error) {
                tabla.innerHTML += `<tr><td colspan="5">Error al consultar checadas</td></tr>`;
                return;
            }
            if (!data || data.length === 0) {
                tabla.innerHTML += `<tr><td colspan="5">Sin resultados</td></tr>`;
                return;
            }
            data.forEach(row => {
                tabla.innerHTML += `<tr>
                    <td>${row.nombre}</td>
                    <td>${row.sucursal}</td>
                    <td>${row.fecha}</td>
                    <td>${row.hora}</td>
                    <td>${row.tipo === 'entrada' ? 'Entrada' : 'Salida'}</td>
                </tr>`;
            });
            window.checadasExport = data;
        }

        function exportarChecadasCSV() {
            const datos = window.checadasExport || [];
            if (!datos.length) {
                alert('No hay datos para exportar');
                return;
            }
            const encabezados = ['Nombre', 'Sucursal', 'Fecha', 'Hora', 'Tipo'];
            const filas = datos.map(row => [
                row.nombre, row.sucursal, row.fecha, row.hora, row.tipo
            ]);
            let csv = encabezados.join(',') + '\n';
            filas.forEach(fila => {
                csv += fila.map(campo => `"${(campo || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checadas.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Funciones de check-in/out ---
        function setCheckInStatus(status, fechaLocal, usuarioId) {
            localStorage.setItem(`checkInStatus_${usuarioId}_${fechaLocal}`, status);
        }
        function getCheckInStatus(fechaLocal, usuarioId) {
            const status = localStorage.getItem(`checkInStatus_${usuarioId}_${fechaLocal}`);
            return status === 'REALIZADO' ? 'Check In REALIZADO' : 'Check In NO realizado';
        }
        function mostrarUltimoCheckIn() {
            const fechaLocal = getFechaLocal();
            if (!usuarioActual) return;
            const texto = getCheckInStatus(fechaLocal, usuarioActual.id);
            const div = document.getElementById('ultimoCheckIn');
            div.textContent = texto;
            div.style.color = texto === 'Check In REALIZADO' ? '#28a745' : '#dc3545';
        }

        // --- Funciones de tabulador y QR ---
        function generarTicketTabulador(event) {
            event.preventDefault();
            const fecha = document.getElementById('fecha').value;
            const sucursal = document.getElementById('sucursal').value;
            const responsable = document.getElementById('responsable').value.toUpperCase();
            const billetes = {
                mil: parseInt(document.getElementById('mil').value),
                quinientos: parseInt(document.getElementById('quinientos').value),
                doscientos: parseInt(document.getElementById('doscientos').value),
                cien: parseInt(document.getElementById('cien').value),
                cincuenta: parseInt(document.getElementById('cincuenta').value),
                veinte: parseInt(document.getElementById('veinte').value),
                monedas: parseInt(document.getElementById('monedas').value)
            };
            const total = (billetes.mil * 1000) + (billetes.quinientos * 500) +
                        (billetes.doscientos * 200) + (billetes.cien * 100) +
                        (billetes.cincuenta * 50) + (billetes.veinte * 20) + billetes.monedas;
            const qrData = {
                fecha: formatDate(fecha),
                sucursal: sucursal,
                responsable: responsable,
                total: total,
                billetes: billetes
            };
            document.getElementById('sucursalResult').innerText = `Sucursal: ${sucursal}`;
            document.getElementById('responsableResult').innerText = `Responsable: ${responsable}`;
            document.getElementById('fechaResult').innerText = `Fecha: ${formatDate(fecha)}`;
            document.getElementById('detallesResult').innerHTML = `$1000: ${billetes.mil}<br>$500: ${billetes.quinientos}<br>$200: ${billetes.doscientos}<br>$100: ${billetes.cien}<br>$50: ${billetes.cincuenta}<br>$20: ${billetes.veinte}<br>Monedas: ${billetes.monedas}`;
            document.getElementById('totalResult').innerText = formatNumber(total);
            QRCode.toDataURL(JSON.stringify(qrData), { width: 400, margin: 1 }, function (err, url) {
                if (!err) document.getElementById('qrCode').src = url;
            });
            document.getElementById('ticketResult').style.display = 'block';
        }
        function printEtiqueta() {
            const ticket = document.querySelector('.ticket');
            html2canvas(ticket).then(canvas => {
                const printWindow = window.open('', '', 'width=80mm,height=600');
                printWindow.document.write('<html><head><title>Etiqueta</title></head><body style="margin:0;padding:0;">');
                printWindow.document.body.appendChild(canvas);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            });
        }
        function downloadEtiqueta() {
            const ticket = document.querySelector('.ticket');
            const sucursal = document.getElementById('sucursal').value.charAt(0);
            const fecha = document.getElementById('fecha').value;
            const [year, month, day] = fecha.split('-');
            const fileName = `${sucursal}${day}${month}`;
            html2canvas(ticket).then(canvas => {
                const link = document.createElement('a');
                link.download = `${fileName}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- Sidebar móvil ---
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarAdmin = document.getElementById('sidebarAdmin');
        const sidebarEmpleado = document.getElementById('sidebarEmpleado');

        function closeSidebarMobile() {
            sidebarAdmin.classList.remove('sidebar-mobile');
            sidebarEmpleado.classList.remove('sidebar-mobile');
            sidebarOverlay.classList.remove('active');
        }

        sidebarToggleBtn.addEventListener('click', () => {
            if (sidebarAdmin.style.display === 'flex') {
                sidebarAdmin.classList.add('sidebar-mobile');
            }
            if (sidebarEmpleado.style.display === 'flex') {
                sidebarEmpleado.classList.add('sidebar-mobile');
            }
            sidebarOverlay.classList.add('active');
        });

        sidebarOverlay.addEventListener('click', closeSidebarMobile);

        document.querySelectorAll('.slidebar .sidebar-btns button, .slidebar .sidebar-footer button').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.innerWidth <= 900) closeSidebarMobile();
            });
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth > 900) closeSidebarMobile();
        });

        // --- DOMContentLoaded: Asignación de eventos y lógica principal ---
        window.addEventListener('DOMContentLoaded', async () => {
            ocultarPaneles();
            // --- Login ---
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = document.getElementById('nombre').value.trim();
                const nip = document.getElementById('nip').value.trim();
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('nombre', nombre)
                    .eq('nip', nip)
                    .eq('activo', true)
                    .single();
                const mensaje = document.getElementById('mensaje');
                if (error || !data) {
                    mensaje.textContent = '❌ Usuario o NIP incorrecto';
                } else {
                    mensaje.textContent = `✅ Bienvenido, ${data.nombre} | Rol: ${data.rol}`;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('loginTitle').textContent = '';
                    document.getElementById('bienvenida').textContent = `Bienvenido, ${data.nombre}`;
                    usuarioActual = data;
                    // Agrega esta línea para mostrar el nombre en el sidebar
                    if (data.rol === 'empleado') {
                        document.getElementById('employeeNameSpan').textContent = data.nombre;
                    }
                    mostrarPanel(data.rol);
                    if (data.rol === 'empleado') {
                        // Selección de sucursal
                        const hoy = new Date();
                        const yyyy = hoy.getFullYear();
                        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
                        const dd = String(hoy.getDate()).padStart(2, '0');
                        const fechaLocal = `${yyyy}-${mm}-${dd}`;
                        let sucursalGuardada = localStorage.getItem(`sucursalEmpleado_${data.id}_${fechaLocal}`);
                        let sucursal = sucursalGuardada;
                        if (!sucursal) {
                            sucursal = prompt("Selecciona tu sucursal (A, B, C, D, E, F):");
                            if (['A', 'B', 'C', 'D', 'E', 'F'].includes(sucursal)) {
                                localStorage.setItem(`sucursalEmpleado_${data.id}_${fechaLocal}`, sucursal);
                            } else {
                                mensaje.textContent = '❌ Sucursal no válida';
                                return;
                            }
                        }
                        document.getElementById('sucursalEmpleado').textContent = `Sucursal: ${sucursal}`;
                        document.getElementById('seccionAvisosEmpleado').style.display = 'none';
                        document.getElementById('seccionTabuladorEmpleado').style.display = 'none';
                        cargarAvisos();
                        sucursalActual = sucursal;
                        mostrarUltimoCheckIn();
                    }
                }
            });
            // --- Cerrar sesión ---
            document.getElementById('cerrarSesionAdmin').addEventListener('click', () => location.reload());
            document.getElementById('cerrarSesionEmpleado').addEventListener('click', () => location.reload());
            // --- Crear usuario ---
            document.getElementById('formCrear').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = document.getElementById('nuevoNombre').value.trim();
                const nip = document.getElementById('nuevoNip').value.trim();
                const rol = document.getElementById('nuevoRol').value;
                const { error } = await supabase.from('usuarios').insert([{ nombre, nip, rol, activo: true }]);
                const mensaje = document.getElementById('mensaje');
                if (error) {
                    mensaje.textContent = '❌ Error al crear usuario';
                } else {
                    mensaje.textContent = `✅ Usuario ${nombre} creado correctamente`;
                    document.getElementById('formCrear').reset();
                    cargarUsuarios();
                }
            });
            // --- Checadas admin ---
            document.getElementById('formFecha').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                cargarChecadas(fechaInicio, fechaFin);
            });
            document.getElementById('btnDescargarExcel').addEventListener('click', exportarChecadasCSV);
            // --- Avisos admin ---
            document.getElementById('formAviso').addEventListener('submit', (e) => {
                e.preventDefault();
                const texto = document.getElementById('avisoTexto').value;
                const rol = document.getElementById('rolDestino').value;
                const sucursal = document.getElementById('sucursales').value;
                document.getElementById('mensaje').textContent = `📣 Aviso enviado a ${rol} en ${sucursal}`;
                e.target.reset();
            });
            document.getElementById('btnBorrarAvisos').addEventListener('click', async () => {
                if (!confirm('¿Seguro que deseas borrar todos los avisos?')) return;
                const { error } = await supabase.from('avisos').delete().neq('id', 0);
                if (error) {
                    document.getElementById('mensaje').textContent = '❌ Error al borrar avisos';
                } else {
                    document.getElementById('mensaje').textContent = '🗑️ Todos los avisos han sido borrados';
                    cargarAvisos();
                }
            });
            // --- Check In/Out empleado ---
            document.getElementById('btnCheckIn').addEventListener('click', async () => {
                if (!usuarioActual) return;
                const fechaLocal = getFechaLocal();
                const hora = new Date().toLocaleTimeString();
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    await supabase.from('checadas').insert([{
                        usuario_id: usuarioActual.id,
                        nombre: usuarioActual.nombre,
                        sucursal: sucursalActual,
                        fecha: fechaLocal,
                        hora: hora,
                        tipo: 'entrada',
                        ubicacion: `${lat},${lng}`
                    }]);
                    document.getElementById('mensaje').textContent = '✅ Check In registrado';
                    setCheckInStatus('REALIZADO', fechaLocal, usuarioActual.id);
                    document.getElementById('ultimoCheckIn').textContent = 'Check In REALIZADO';
                    document.getElementById('ultimoCheckIn').style.color = '#28a745';
                }, () => {
                    document.getElementById('mensaje').textContent = '❌ No se pudo obtener la ubicación';
                });
            });
            document.getElementById('btnCheckOut').addEventListener('click', async () => {
                if (!usuarioActual) return;
                const fechaLocal = getFechaLocal();
                const hora = new Date().toLocaleTimeString();
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    await supabase.from('checadas').insert([{
                        usuario_id: usuarioActual.id,
                        nombre: usuarioActual.nombre,
                        sucursal: sucursalActual,
                        fecha: fechaLocal,
                        hora: hora,
                        tipo: 'salida',
                        ubicacion: `${lat},${lng}`
                    }]);
                    document.getElementById('ultimoCheckIn').textContent = 'Check In NO realizado';
                    document.getElementById('ultimoCheckIn').style.color = '#dc3545';
                    document.getElementById('mensaje').textContent = '✅ Check Out registrado';
                    setCheckInStatus('NO', fechaLocal, usuarioActual.id);
                    localStorage.removeItem(`sucursalEmpleado_${usuarioActual.id}_${fechaLocal}`);
                }, () => {
                    document.getElementById('mensaje').textContent = '❌ No se pudo obtener la ubicación';
                });
            });
            // --- Tabulador empleado ---
            document.getElementById('billetesForm').addEventListener('submit', generarTicketTabulador);
            document.querySelector('.print-btn').addEventListener('click', printEtiqueta);
            document.getElementById('downloadBtn').addEventListener('click', downloadEtiqueta);
            // --- Botones de panel empleado ---
            document.getElementById('btnMostrarTabulador').addEventListener('click', () => mostrarSeccion('tabuladorEmpleado'));
            document.getElementById('btnMostrarAmigoPaguitos').addEventListener('click', () => mostrarSeccion('amigoPaguitos'));
            document.getElementById('btnMostrarTarifario').addEventListener('click', () => mostrarSeccion('tarifario'));
            document.getElementById('btnReportesEmpleado').addEventListener('click', () => window.open(linkReporteGlobal, '_blank'));
            document.getElementById('btnInventarioEmpleado').addEventListener('click', () => window.open(linkInventarioGlobal, '_blank'));
        });

        // --- Mostrar secciones panel ---
        window.mostrarSeccion = (id) => {
            const secciones = {
                crear: document.getElementById('seccionCrear'),
                verUsuarios: document.getElementById('seccionUsuarios'),
                checadas: document.getElementById('seccionChecadas'),
                aviso: document.getElementById('seccionAviso'),
                reporte: document.getElementById('seccionReporte'),
                avisosEmpleado: document.getElementById('seccionAvisosEmpleado'),
                tabuladorEmpleado: document.getElementById('seccionTabuladorEmpleado'),
                amigoPaguitos: document.getElementById('seccionAmigoPaguitos'),
                tarifario: document.getElementById('seccionTarifario'),
                inventario: document.getElementById('seccionInventario')
            };
            for (const key in secciones) {
                secciones[key].style.display = 'none';
            }
            secciones[id].style.display = 'block';
            if (id === 'verUsuarios') cargarUsuarios();
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <!-- Botón hamburguesa para móvil -->
    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="Abrir menú">
        <i class="fas fa-bars"></i>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar Admin -->
    <div class="slidebar" id="sidebarAdmin" style="display:none;">
        <div class="logo">
            <i class="fas fa-user-shield"></i>
            <span>Admin Jeeapcel</span>
        </div>
        <div class="sidebar-btns">
            <button onclick="mostrarSeccion('crear')">
                <i class="fas fa-user-plus"></i> <span>Crear Usuario</span>
            </button>
            <button onclick="mostrarSeccion('verUsuarios')">
                <i class="fas fa-users"></i> <span>Ver Usuarios</span>
            </button>
            <button onclick="mostrarSeccion('checadas')">
                <i class="fas fa-calendar-check"></i> <span>Checadas</span>
            </button>
            <button onclick="mostrarSeccion('aviso')">
                <i class="fas fa-bullhorn"></i> <span>Aviso</span>
            </button>
        </div>
        <div class="sidebar-footer">
            <button id="cerrarSesionAdmin">
                <i class="fas fa-sign-out-alt"></i> <span>Cerrar sesión</span>
            </button>
        </div>
    </div>

    <!-- Sidebar Empleado -->
    <div class="slidebar" id="sidebarEmpleado" style="display:none;">
        <div class="logo">
            <i class="fas fa-user"></i>
            <span id="employeeNameSpan">Empleado</span>
        </div>
        <div class="sidebar-btns">
            <button id="btnMostrarTabulador">
                <i class="fas fa-table"></i> <span>Tabulador</span>
            </button>
            <button id="btnReportesEmpleado">
                <i class="fas fa-link"></i> <span>Reportes</span>
            </button>
            <button onclick="mostrarSeccion('avisosEmpleado')">
                <i class="fas fa-bullhorn"></i> <span>Avisos</span>
            </button>
            <button id="btnMostrarAmigoPaguitos">
                <i class="fas fa-user-friends"></i> <span>Amigo Paguitos</span>
            </button>
            <button id="btnMostrarTarifario">
                <i class="fas fa-file-alt"></i> <span>Tarifario</span>
            </button>
            <button id="btnInventarioEmpleado">
                <i class="fas fa-boxes"></i> <span>Inventarios</span>
            </button>
        </div>
        <div class="sidebar-footer">
            <button id="cerrarSesionEmpleado">
                <i class="fas fa-sign-out-alt"></i> <span>Cerrar sesión</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <h2 id="loginTitle">
            <i class="fas fa-lock"></i> Iniciar sesión en Jeeapcel
        </h2>
        <h3 id="bienvenida"></h3>
        <form id="loginForm">
            <input type="text" id="nombre" placeholder="Nombre" required>
            <input type="password" id="nip" placeholder="NIP" required>
            <button type="submit">Entrar</button>
        </form>

        <!-- Panel Admin -->
        <div class="panel" id="adminPanel">
            <h3><i class="fas fa-user-shield"></i> Panel de administrador</h3>
            <div id="seccionCrear" class="seccion">
                <h4><i class="fas fa-user-plus"></i> Crear Usuario</h4>
                <form id="formCrear">
                    <input type="text" id="nuevoNombre" placeholder="Nombre" required><br>
                    <input type="password" id="nuevoNip" placeholder="NIP" required><br>
                    <select id="nuevoRol" required>
                        <option value="">Selecciona un rol</option>
                        <option value="admin">admin</option>
                        <option value="supervisor">supervisor</option>
                        <option value="empleado">empleado</option>
                    </select><br>
                    <button type="submit">Crear</button>
                </form>
            </div>
            <div id="seccionUsuarios" class="seccion">
                <h4><i class="fas fa-users"></i> Usuarios activos</h4>
                <table id="tablaUsuarios"></table>
            </div>
            <div id="seccionChecadas" class="seccion">
                <h4><i class="fas fa-calendar-check"></i> Checadas por fecha</h4>
                <form id="formFecha">
                    <input type="date" id="fechaInicio" required>
                    <input type="date" id="fechaFin" required>
                    <button type="submit">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    <button type="button" id="btnDescargarExcel">
                        <i class="fas fa-file-excel"></i> Descargar Excel
                    </button>
                </form>
                <table id="tablaChecadas"></table>
            </div>
            <div id="seccionAviso" class="seccion">
                <h4><i class="fas fa-bullhorn"></i> Crear Aviso</h4>
                <form id="formAviso">
                    <textarea id="avisoTexto" placeholder="Escribe el aviso..." required></textarea><br>
                    <select id="rolDestino">
                        <option value="todos">Todos los roles</option>
                        <option value="admin">Solo admins</option>
                        <option value="supervisor">Supervisores</option>
                        <option value="empleado">Empleados</option>
                    </select>
                    <select id="sucursales">
                        <option value="todas">Todas las sucursales</option>
                        <option value="A">Sucursal A</option>
                        <option value="B">Sucursal B</option>
                        <option value="C">Sucursal C</option>
                        <option value="D">Sucursal D</option>
                        <option value="E">Sucursal E</option>
                        <option value="F">Sucursal F</option>
                    </select>
                    <button type="submit">
                        <i class="fas fa-paper-plane"></i> Enviar aviso
                    </button>
                </form>
                <div style="display: flex; justify-content: center; width: 100%;">
                    <button id="btnBorrarAvisos" style="background:#ff4d4f; margin-top:10px;">
                        <i class="fas fa-trash"></i> Borrar Avisos
                    </button>
                </div>
            </div>
            <div id="seccionReporte" class="seccion" style="display:none"></div>
            <div id="seccionInventario" class="seccion" style="display:none"></div>
        </div>

        <!-- Panel Empleado -->
        <div class="panel" id="empleadoPanel">
            <h3><i class="fas fa-user"></i> Panel de Empleado</h3>
            <h4 id="sucursalEmpleado"></h4>
            <div id="ultimoCheckIn" style="margin-bottom:10px; color:#28a745; font-weight:bold;"></div>
            <div class="check-btns">
                <button id="btnCheckIn" style="background:#28a745;">
                    <i class="fas fa-sign-in-alt"></i> Check In
                </button>
                <button id="btnCheckOut" style="background:#dc3545;">
                    <i class="fas fa-sign-out-alt"></i> Check Out
                </button>
            </div>
            <div class="logout-btn" style="display:none"></div>
            <div id="seccionAvisosEmpleado" class="seccion">
                <h4><i class="fas fa-bullhorn"></i> Avisos</h4>
                <table id="tablaAvisosEmpleado"></table>
            </div>
            <div id="seccionTabuladorEmpleado" class="seccion">
                <h4><i class="fas fa-table"></i> Tabulador de Ingreso de Billetes</h4>
                <form id="billetesForm">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" name="fecha" required>

                    <label for="sucursal">Sucursal:</label>
                    <select id="sucursal" name="sucursal" required>
                        <option value="" selected disabled>Seleccionar Sucursal</option>
                        <option value="A">AMIRA</option>
                        <option value="B">BELEM</option>
                        <option value="C">CARLA</option>
                        <option value="D">DANNA</option>
                        <option value="E">ELENA</option>
                        <option value="F">FANNY</option>
                    </select>

                    <label for="responsable">Responsable:</label>
                    <input type="text" id="responsable" name="responsable" placeholder="Nombre del responsable" required>

                    <label for="mil">$1000:</label>
                    <input type="number" id="mil" name="mil" value="0" required>

                    <label for="quinientos">$500:</label>
                    <input type="number" id="quinientos" name="quinientos" value="0" required>

                    <label for="doscientos">$200:</label>
                    <input type="number" id="doscientos" name="doscientos" value="0" required>

                    <label for="cien">$100:</label>
                    <input type="number" id="cien" name="cien" value="0" required>

                    <label for="cincuenta">$50:</label>
                    <input type="number" id="cincuenta" name="cincuenta" value="0" required>

                    <label for="veinte">$20:</label>
                    <input type="number" id="veinte" name="veinte" value="0" required>

                    <label for="monedas">Monedas:</label>
                    <input type="number" id="monedas" name="monedas" value="0" required>

                    <button type="submit">
                        <i class="fas fa-qrcode"></i> Generar QR
                    </button>
                </form>

                <div id="ticketResult" class="ticket" style="display:none;">
                    <h2 id="sucursalResult"></h2>
                    <p id="responsableResult"></p>
                    <p><span id="fechaResult" class="bold"></span></p>
                    <p id="detallesResult"></p>
                    <img id="qrCode" src="" alt="Código QR">
                    <h3 class="total-center">Total: $<span id="totalResult"></span></h3>
                </div>

                <button class="print-btn" onclick="printEtiqueta();">
                    <i class="fas fa-print"></i> Imprimir Etiqueta
                </button>
                <button class="print-btn" id="downloadBtn">
                    <i class="fas fa-download"></i> Descargar Etiqueta
                </button>
            </div>
            <div style="margin: 20px 0; display:flex; gap:8px; justify-content:center;"></div>
            <div id="seccionAmigoPaguitos" class="seccion">
                <h4><i class="fas fa-user-friends"></i> Amigo Paguitos - Formulario</h4>
                <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSc_rGTuBDJ3IcqjMFk0xnkte_foRZaQWJ6k2tbDQ6h10Wt4Rg/viewform?embedded=true" width="100%" height="1200" frameborder="0" marginheight="0" marginwidth="0" style="background:#fff; border-radius:12px;">Cargando…</iframe>
            </div>

            <div id="seccionTarifario" class="seccion">
                <h4><i class="fas fa-file-alt"></i> Tarifario - Formulario</h4>
                <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeKUqZFXZ5pi7CrcfwJUEQCg0Bd1F2GGrEnyPtDbwLn_ohOeQ/viewform?embedded=true" width="100%" height="1200" frameborder="0" marginheight="0" marginwidth="0" style="background:#fff; border-radius:12px;">Cargando…</iframe>
            </div>
        </div>
        <div id="mensaje"></div>
        <div style="width:100%; display:flex; justify-content:center; margin:80px 0 36px 0;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/ab/Telcel_logo_2022.svg" alt="Telcel" style="max-width:120px; height:auto; opacity:0.85;">
        </div>
    </div>
    <script type="module">
        // --- Funciones de autenticación y paneles ---
        function mostrarPanel(rol) {
            document.getElementById('adminPanel').style.display = rol === 'admin' ? 'block' : 'none';
            document.getElementById('empleadoPanel').style.display = rol === 'empleado' ? 'block' : 'none';
            document.getElementById('sidebarAdmin').style.display = rol === 'admin' ? 'flex' : 'none';
            document.getElementById('sidebarEmpleado').style.display = rol === 'empleado' ? 'flex' : 'none';
            // Oculta los botones de cerrar sesión antiguos
            document.getElementById('cerrarSesionAdmin').style.display = 'none';
            document.getElementById('cerrarSesionEmpleado').style.display = 'none';
        }
        function ocultarPaneles() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('empleadoPanel').style.display = 'none';
            document.getElementById('sidebarAdmin').style.display = 'none';
            document.getElementById('sidebarEmpleado').style.display = 'none';
        }

        // --- Funciones de usuario y avisos ---
        async function cargarUsuarios() {
            const { data } = await supabase.from('usuarios').select('*').eq('activo', true);
            const tabla = document.getElementById('tablaUsuarios');
            tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>Última entrada</th><th>Desactivar</th></tr>';
            data.forEach(user => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${user.nombre}</td>
                    <td>${user.rol}</td>
                    <td>${user.ultima_entrada ? new Date(user.ultima_entrada).toLocaleString() : '-'}</td>
                    <td><button onclick="desactivarUsuario('${user.id}')">❌</button></td>
                `;
                tabla.appendChild(fila);
            });
        }
        window.desactivarUsuario = async (id) => {
            await supabase.from('usuarios').update({ activo: false }).eq('id', id);
            setMensaje('Usuario desactivado', 'warn');
            cargarUsuarios();
        };

        async function cargarAvisos() {
            const { data } = await supabase.from('avisos').select('*');
            const tabla = document.getElementById('tablaAvisosEmpleado');
            tabla.innerHTML = '<tr><th>Aviso</th><th>Sucursal</th></tr>';
            data.forEach(aviso => {
                const fila = document.createElement('tr');
                fila.innerHTML = `<td>${aviso.texto}</td><td>${aviso.sucursal}</td>`;
                tabla.appendChild(fila);
            });
        }

        // --- Funciones de checadas ---
        async function cargarChecadas(fechaInicio, fechaFin) {
            const { data, error } = await supabase
                .from('checadas')
                .select('*')
                .gte('fecha', fechaInicio)
                .lte('fecha', fechaFin)
                .order('fecha', { ascending: true })
                .order('hora', { ascending: true });
            const tabla = document.getElementById('tablaChecadas');
            tabla.innerHTML = '<tr><th>Nombre</th><th>Sucursal</th><th>Fecha</th><th>Hora</th><th>Tipo</th></tr>';
            if (error) {
                tabla.innerHTML += `<tr><td colspan="5">Error al consultar checadas</td></tr>`;
                return;
            }
            if (!data || data.length === 0) {
                tabla.innerHTML += `<tr><td colspan="5">Sin resultados</td></tr>`;
                return;
            }
            data.forEach(row => {
                tabla.innerHTML += `<tr>
                    <td>${row.nombre}</td>
                    <td>${row.sucursal}</td>
                    <td>${row.fecha}</td>
                    <td>${row.hora}</td>
                    <td>${row.tipo === 'entrada' ? 'Entrada' : 'Salida'}</td>
                </tr>`;
            });
            window.checadasExport = data;
        }

        function exportarChecadasCSV() {
            const datos = window.checadasExport || [];
            if (!datos.length) {
                alert('No hay datos para exportar');
                return;
            }
            const encabezados = ['Nombre', 'Sucursal', 'Fecha', 'Hora', 'Tipo'];
            const filas = datos.map(row => [
                row.nombre, row.sucursal, row.fecha, row.hora, row.tipo
            ]);
            let csv = encabezados.join(',') + '\n';
            filas.forEach(fila => {
                csv += fila.map(campo => `"${(campo || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checadas.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Funciones de check-in/out ---
        function setCheckInStatus(status, fechaLocal, usuarioId) {
            localStorage.setItem(`checkInStatus_${usuarioId}_${fechaLocal}`, status);
        }
        function getCheckInStatus(fechaLocal, usuarioId) {
            const status = localStorage.getItem(`checkInStatus_${usuarioId}_${fechaLocal}`);
            return status === 'REALIZADO' ? 'Check In REALIZADO' : 'Check In NO realizado';
        }
        function mostrarUltimoCheckIn() {
            const fechaLocal = getFechaLocal();
            if (!usuarioActual) return;
            const texto = getCheckInStatus(fechaLocal, usuarioActual.id);
            const div = document.getElementById('ultimoCheckIn');
            div.textContent = texto;
            div.style.color = texto === 'Check In REALIZADO' ? '#28a745' : '#dc3545';
        }

        // --- Funciones de tabulador y QR ---
        function generarTicketTabulador(event) {
            event.preventDefault();
            const fecha = document.getElementById('fecha').value;
            const sucursal = document.getElementById('sucursal').value;
            const responsable = document.getElementById('responsable').value.toUpperCase();
            const billetes = {
                mil: parseInt(document.getElementById('mil').value),
                quinientos: parseInt(document.getElementById('quinientos').value),
                doscientos: parseInt(document.getElementById('doscientos').value),
                cien: parseInt(document.getElementById('cien').value),
                cincuenta: parseInt(document.getElementById('cincuenta').value),
                veinte: parseInt(document.getElementById('veinte').value),
                monedas: parseInt(document.getElementById('monedas').value)
            };
            const total = (billetes.mil * 1000) + (billetes.quinientos * 500) +
                        (billetes.doscientos * 200) + (billetes.cien * 100) +
                        (billetes.cincuenta * 50) + (billetes.veinte * 20) + billetes.monedas;
            const qrData = {
                fecha: formatDate(fecha),
                sucursal: sucursal,
                responsable: responsable,
                total: total,
                billetes: billetes
            };
            document.getElementById('sucursalResult').innerText = `Sucursal: ${sucursal}`;
            document.getElementById('responsableResult').innerText = `Responsable: ${responsable}`;
            document.getElementById('fechaResult').innerText = `Fecha: ${formatDate(fecha)}`;
            document.getElementById('detallesResult').innerHTML = `$1000: ${billetes.mil}<br>$500: ${billetes.quinientos}<br>$200: ${billetes.doscientos}<br>$100: ${billetes.cien}<br>$50: ${billetes.cincuenta}<br>$20: ${billetes.veinte}<br>Monedas: ${billetes.monedas}`;
            document.getElementById('totalResult').innerText = formatNumber(total);
            QRCode.toDataURL(JSON.stringify(qrData), { width: 400, margin: 1 }, function (err, url) {
                if (!err) document.getElementById('qrCode').src = url;
            });
            document.getElementById('ticketResult').style.display = 'block';
        }
        function printEtiqueta() {
            const ticket = document.querySelector('.ticket');
            html2canvas(ticket).then(canvas => {
                const printWindow = window.open('', '', 'width=80mm,height=600');
                printWindow.document.write('<html><head><title>Etiqueta</title></head><body style="margin:0;padding:0;">');
                printWindow.document.body.appendChild(canvas);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            });
        }
        function downloadEtiqueta() {
            const ticket = document.querySelector('.ticket');
            const sucursal = document.getElementById('sucursal').value.charAt(0);
            const fecha = document.getElementById('fecha').value;
            const [year, month, day] = fecha.split('-');
            const fileName = `${sucursal}${day}${month}`;
            html2canvas(ticket).then(canvas => {
                const link = document.createElement('a');
                link.download = `${fileName}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- Mensajes con iconos en vez de emojis ---
        function setMensaje(texto, tipo = 'info') {
            const mensaje = document.getElementById('mensaje');
            let icon = '';
            if (tipo === 'ok') icon = '<i class="fas fa-check-circle" style="color:#28a745"></i>';
            else if (tipo === 'error') icon = '<i class="fas fa-times-circle" style="color:#dc3545"></i>';
            else if (tipo === 'warn') icon = '<i class="fas fa-exclamation-triangle" style="color:#ffc107"></i>';
            else if (tipo === 'info') icon = '<i class="fas fa-info-circle" style="color:#2563eb"></i>';
            mensaje.innerHTML = icon + ' ' + texto;
        }
    </script>
</body>
</html>
