<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checador Jeeapcel - Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #eef3f8;
      padding: 40px;
      text-align: center;
    }

    h2, h3, h4 {
      color: #222;
    }

    form, .panel, .seccion {
      background: white;
      display: inline-block;
      padding: 20px;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: left;
      max-width: 500px;
    }

    input, select, textarea {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }

    button {
      padding: 10px 20px;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }

    button:hover {
      background: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    #mensaje {
      margin-top: 20px;
      font-size: 1.1em;
    }

    .seccion {
      display: none;
    }

    .check-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://mubtfuksnxtbjxrrwzqh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11YnRmdWtzbnh0Ymp4cnJ3enFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Njc0OTcsImV4cCI6MjA2NDI0MzQ5N30.B7ZyBG2g4hCfdI2A2aX852icnHb_JPpfc0VyO0Zr4PA'
    );

    window.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('loginForm');
      const loginTitle = document.getElementById('loginTitle');
      const adminPanel = document.getElementById('adminPanel');
      const empleadoPanel = document.getElementById('empleadoPanel');
      const mensaje = document.getElementById('mensaje');
      const cerrarSesion = document.getElementById('cerrarSesion');
      const bienvenida = document.getElementById('bienvenida');

      const secciones = {
        crear: document.getElementById('seccionCrear'),
        verUsuarios: document.getElementById('seccionUsuarios'),
        checadas: document.getElementById('seccionChecadas'),
        aviso: document.getElementById('seccionAviso'),
        reporte: document.getElementById('seccionReporte')
      };

      adminPanel.style.display = 'none';
      empleadoPanel.style.display = 'none';
      cerrarSesion.style.display = 'none';

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value.trim();
        const nip = document.getElementById('nip').value.trim();

        const { data, error } = await supabase
          .from('usuarios')
          .select('*')
          .eq('nombre', nombre)
          .eq('nip', nip)
          .eq('activo', true)
          .single();

        if (error || !data) {
          mensaje.textContent = '‚ùå Usuario o NIP incorrecto';
        } else {
          mensaje.textContent = `‚úÖ Bienvenido, ${data.nombre} | Rol: ${data.rol}`;
          loginForm.style.display = 'none';
          loginTitle.textContent = '';
          cerrarSesion.style.display = 'inline-block';
          bienvenida.textContent = `Bienvenido, ${data.nombre}`;

          localStorage.setItem('nombreUsuario', data.nombre);
          localStorage.setItem('rolUsuario', data.rol);

          if (data.rol === 'admin') {
            adminPanel.style.display = 'block';
          } else {
            empleadoPanel.style.display = 'block';
            seleccionarSucursal();
          }
        }
      });

      cerrarSesion.addEventListener('click', () => {
        localStorage.clear();
        location.reload();
      });
            function seleccionarSucursal() {
        const contenedor = document.getElementById('seleccionarSucursal');
        contenedor.innerHTML = `
          <h4>Selecciona tu sucursal</h4>
          <select id="sucursalEmpleado">
            <option value="">Selecciona</option>
            <option value="A">Sucursal A</option>
            <option value="B">Sucursal B</option>
            <option value="C">Sucursal C</option>
            <option value="D">Sucursal D</option>
            <option value="E">Sucursal E</option>
            <option value="F">Sucursal F</option>
          </select>
          <button onclick="confirmarSucursal()">Confirmar</button>
        `;
      }

      window.confirmarSucursal = () => {
        const sucursal = document.getElementById('sucursalEmpleado').value;
        if (!sucursal) {
          alert('Selecciona una sucursal');
          return;
        }
        localStorage.setItem('sucursalEmpleado', sucursal);
        document.getElementById('seleccionarSucursal').style.display = 'none';
        document.getElementById('checadorEmpleado').style.display = 'block';
        document.getElementById('sucursalActual').textContent = sucursal;
      };

      document.getElementById('checkIn').addEventListener('click', async () => {
        const nombre = localStorage.getItem('nombreUsuario');
        const sucursal = localStorage.getItem('sucursalEmpleado');
        const { error } = await supabase
          .from('checadas')
          .insert([{ nombre, tipo: 'entrada', sucursal, fecha: new Date().toISOString() }]);

        if (error) {
          mensaje.textContent = '‚ùå Error al registrar entrada';
        } else {
          mensaje.textContent = `‚úÖ Entrada registrada para ${nombre}`;
        }
      });

      document.getElementById('checkOut').addEventListener('click', async () => {
        const nombre = localStorage.getItem('nombreUsuario');
        const sucursal = localStorage.getItem('sucursalEmpleado');
        const { error } = await supabase
          .from('checadas')
          .insert([{ nombre, tipo: 'salida', sucursal, fecha: new Date().toISOString() }]);

        if (error) {
          mensaje.textContent = '‚ùå Error al registrar salida';
        } else {
          mensaje.textContent = `‚úÖ Salida registrada para ${nombre}`;
        }
      });

      document.getElementById('formCrear').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('nuevoNombre').value.trim();
        const nip = document.getElementById('nuevoNip').value.trim();
        const rol = document.getElementById('nuevoRol').value;

        const { error } = await supabase.from('usuarios').insert([{ nombre, nip, rol, activo: true }]);

        if (error) {
          mensaje.textContent = '‚ùå Error al crear usuario';
        } else {
          mensaje.textContent = `‚úÖ Usuario ${nombre} creado correctamente`;
          document.getElementById('formCrear').reset();
          cargarUsuarios();
        }
      });

      async function cargarUsuarios() {
        const { data } = await supabase.from('usuarios').select('*').eq('activo', true);
        const tabla = document.getElementById('tablaUsuarios');
        tabla.innerHTML = '<tr><th>Nombre</th><th>Rol</th><th>√öltima entrada</th><th>Desactivar</th></tr>';
        data.forEach(user => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${user.nombre}</td>
            <td>${user.rol}</td>
            <td>${user.ultima_entrada ? new Date(user.ultima_entrada).toLocaleString() : '-'}</td>
            <td><button onclick="desactivarUsuario(${user.id})">‚ùå</button></td>
          `;
          tabla.appendChild(fila);
        });
      }

      window.desactivarUsuario = async (id) => {
        await supabase.from('usuarios').update({ activo: false }).eq('id', id);
        mensaje.textContent = '‚ö†Ô∏è Usuario desactivado';
        cargarUsuarios();
      };
            async function cargarChecadas() {
        const fecha = document.getElementById('fechaBuscada').value;
        const empleadoFiltro = document.getElementById('filtroEmpleado').value;
        const sucursalFiltro = document.getElementById('filtroSucursal').value;

        let query = supabase.from('checadas').select('*');

        if (fecha) {
          query = query
            .gte('fecha', fecha + 'T00:00:00')
            .lte('fecha', fecha + 'T23:59:59');
        }

        if (empleadoFiltro !== 'todos' && empleadoFiltro !== '') {
          query = query.eq('nombre', empleadoFiltro);
        }

        if (sucursalFiltro !== 'todas' && sucursalFiltro !== '') {
          query = query.eq('sucursal', sucursalFiltro);
        }

        const { data, error } = await query;

        const tabla = document.getElementById('tablaChecadas');
        tabla.innerHTML = '<tr><th>Nombre</th><th>Tipo</th><th>Sucursal</th><th>Hora</th></tr>';

        if (error || !data) {
          tabla.innerHTML += `<tr><td colspan="4">‚ùå Error al cargar datos</td></tr>`;
          return;
        }

        data.forEach(checada => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${checada.nombre}</td>
            <td>${checada.tipo === 'entrada' ? 'üü¢ Entrada' : 'üî¥ Salida'}</td>
            <td>${checada.sucursal}</td>
            <td>${new Date(checada.fecha).toLocaleTimeString()}</td>
          `;
          tabla.appendChild(fila);
        });
      }

      document.getElementById('formFecha').addEventListener('submit', (e) => {
        e.preventDefault();
        cargarChecadas();
      });

      async function llenarFiltroEmpleados() {
        const { data } = await supabase.from('usuarios').select('nombre').eq('activo', true);
        const filtro = document.getElementById('filtroEmpleado');
        filtro.innerHTML = '<option value="todos">Todos</option>';
        data.forEach(user => {
          const opt = document.createElement('option');
          opt.value = user.nombre;
          opt.textContent = user.nombre;
          filtro.appendChild(opt);
        });
      }

      llenarFiltroEmpleados();

      document.getElementById('formAviso').addEventListener('submit', (e) => {
        e.preventDefault();
        const texto = document.getElementById('avisoTexto').value;
        const rol = document.getElementById('rolDestino').value;
        const sucursal = document.getElementById('sucursales').value;
        console.log('Aviso creado para', rol, 'en', sucursal, ':', texto);
        mensaje.textContent = `üì£ Aviso enviado a ${rol} en ${sucursal}`;
        e.target.reset();
      });

      document.getElementById('formReporte').addEventListener('submit', (e) => {
        e.preventDefault();
        const link = document.getElementById('nuevoLink').value;
        localStorage.setItem('linkReporte', link);
        mensaje.textContent = 'üîó Link actualizado correctamente';
      });

      window.mostrarSeccion = (id) => {
        for (const key in secciones) {
          secciones[key].style.display = 'none';
        }
        secciones[id].style.display = 'block';
        if (id === 'verUsuarios') cargarUsuarios();
      };
    });
  </script>
  </head>
<body>
  <h2 id="loginTitle">üîê Iniciar sesi√≥n en Jeeapcel</h2>
  <h3 id="bienvenida"></h3>

  <form id="loginForm">
    <input type="text" id="nombre" placeholder="Nombre" required><br>
    <input type="password" id="nip" placeholder="NIP" required><br>
    <button type="submit">Entrar</button>
  </form>

  <div class="panel" id="adminPanel">
    <h3>üõ†Ô∏è Panel de administrador</h3>
    <button onclick="mostrarSeccion('crear')">‚ûï Crear Usuario</button>
    <button onclick="mostrarSeccion('verUsuarios')">üëÅÔ∏è Ver Usuarios Activos</button>
    <button onclick="mostrarSeccion('checadas')">üìÖ Ver Checadas por Fecha</button>
    <button onclick="mostrarSeccion('aviso')">üì£ Crear Aviso</button>
    <button onclick="mostrarSeccion('reporte')">üîó Actualizar Link Reportes</button>
    <button id="cerrarSesion">üîì Cerrar sesi√≥n</button>

    <div id="seccionCrear" class="seccion">
      <h4>‚ûï Crear Usuario</h4>
      <form id="formCrear">
        <input type="text" id="nuevoNombre" placeholder="Nombre" required><br>
        <input type="password" id="nuevoNip" placeholder="NIP" required><br>
        <select id="nuevoRol" required>
          <option value="">Selecciona un rol</option>
          <option value="admin">admin</option>
          <option value="supervisor">supervisor</option>
          <option value="empleado">empleado</option>
        </select><br>
        <button type="submit">Crear</button>
      </form>
    </div>

    <div id="seccionUsuarios" class="seccion">
      <h4>üëÅÔ∏è Usuarios activos</h4>
      <table id="tablaUsuarios"></table>
    </div>

    <div id="seccionChecadas" class="seccion">
      <h4>üìÖ Checadas por fecha</h4>
      <form id="formFecha">
        <input type="date" id="fechaBuscada" required>
        <select id="filtroEmpleado">
          <option value="">-- Filtrar por empleado --</option>
        </select>
        <select id="filtroSucursal">
          <option value="">-- Filtrar por sucursal --</option>
          <option value="A">Sucursal A</option>
          <option value="B">Sucursal B</option>
          <option value="C">Sucursal C</option>
          <option value="D">Sucursal D</option>
          <option value="E">Sucursal E</option>
          <option value="F">Sucursal F</option>
        </select>
        <button type="submit">Buscar</button>
      </form>
      <table id="tablaChecadas"></table>
    </div>
        <div id="seccionAviso" class="seccion">
      <h4>üì£ Crear Aviso</h4>
      <form id="formAviso">
        <textarea id="avisoTexto" placeholder="Escribe el aviso..." required></textarea><br>
        <select id="rolDestino">
          <option value="todos">Todos los roles</option>
          <option value="admin">Solo admins</option>
          <option value="supervisor">Supervisores</option>
          <option value="empleado">Empleados</option>
        </select>
        <select id="sucursales">
          <option value="todas">Todas las sucursales</option>
          <option value="A">Sucursal A</option>
          <option value="B">Sucursal B</option>
          <option value="C">Sucursal C</option>
          <option value="D">Sucursal D</option>
          <option value="E">Sucursal E</option>
          <option value="F">Sucursal F</option>
        </select>
        <button type="submit">Enviar aviso</button>
      </form>
    </div>

    <div id="seccionReporte" class="seccion">
      <h4>üîó Actualizar link de reportes</h4>
      <form id="formReporte">
        <input type="url" id="nuevoLink" placeholder="Pega aqu√≠ el nuevo link del reporte" required>
        <button type="submit">Actualizar</button>
      </form>
    </div>
  </div>

  <div class="panel" id="empleadoPanel" style="display:none;">
    <h3 id="tituloEmpleado">üë§ Panel de empleado</h3>
    <div id="avisoEmpleado"></div>
    <button onclick="checkIn()">‚úÖ Check In</button>
    <button onclick="checkOut()">‚ùå Check Out</button>
    <br><br>
    <button onclick="abrirReporte()">üìé Ver link de reportes</button>
    <button id="cerrarSesionEmpleado">üîì Cerrar sesi√≥n</button>
  </div>

  <div id="mensaje"></div>
</body>
</html>
